!function(){"use strict";var R=window.tabId,f=window.Tabs[R],G=f.commit,J=function(){return f.data},V=window.i18n;f.continue=function(){var t=f.$form,O=randomObjectId(),I=0,m={material:{title:"Material"},pattern:{title:V({en_us:"Pattern",pt_br:"Modelo"})},size:{title:V({en_us:"Size",pt_br:"Tamanho"})},colors:{title:V({en_us:"Colors",pt_br:"Cores"}),options:[{text:V({en_us:"Blue",pt_br:"Azul"}),value:"blue",colors:["#0000ff"]},{text:V({en_us:"White",pt_br:"Branco"}),value:"white",colors:["#ffffff"]}]}},h={};window.callApi("grids.json?fields=title,grid_id,options","GET",function(t,n){if(!t)for(var i=0;i<n.result.length;i++){var e=n.result[i],a=normalizeString(e.title);for(var o in m)m.hasOwnProperty(o)&&o!==e.grid_id&&normalizeString(m[o].title)===a&&delete m[o];m[e.grid_id]=e}});var a=function(t,n,i){t.typeahead({hint:!0,highlight:!0,minLength:1},{name:n,source:i})},o=$("#t"+R+"-grids-list"),r='<div class="row gap-2"><div class="col-6"><div class="flexbox align-items-center"><div class="i-drag"></div><div class="input-group"><div class="input-group-prepend"><button class="btn btn-light remove-grid" type="button"><i class="fa fa-trash"></i></button></div><input class="form-control" type="text" name="grid" placeholder="'+V({en_us:"Size",pt_br:"Tamanho"})+'"></div></div></div><div class="col-6 hidden option-block"><div class="input-group"><input class="form-control" type="text" name="option" placeholder="GG"><div class="input-group-append"><button class="btn btn-light add-option" type="button"><i class="fa fa-plus"></i></button></div></div></div></div><ul class="hide-empty badges-list"></ul>';window.Sortable.create(o[0],{onUpdate:function(t){var n=Object.keys(h),i=n.splice(t.oldIndex,1)[0];i&&n.splice(t.newIndex,0,i);for(var e={},a=0;a<n.length;a++){var o=n[a];e[o]=h[o]}h=e,b()}});var v=0,n=function(t){var n=o.find('input[name="grid"]').filter(function(){return""===$(this).val()});if(n.length)n.focus();else{var s=$("<li />",{html:r});o.append(s);var l,c,d,i=s.find('input[name="grid"]'),u=s.find(".option-block"),f=u.find('input[name="option"]'),e=!0,p=[];i.change(function(){if(!d){d=!0;var t=$(this).val().trim();if(""!==t){var n;for(var i in c&&(n=c),c=normalizeString(t),m)if(m.hasOwnProperty(i)&&normalizeString(m[i].title)===c){c=i;break}if(n!==c){if(p=function(t){var n=[];if(m[t]){var i=m[t].options;if(void 0!==i)for(var e=0;e<i.length;e++)n.push(i[e].text)}return n}(c),h.hasOwnProperty(c)){for(var e=2;h.hasOwnProperty(c+"_"+e);)e++;c+="_"+e}n?(h[c]=h[n],delete h[n]):h[c]=[],m.hasOwnProperty(c)||(m[c]={title:t}),$(this).data("grid-id",c)}if("colors"===c){if(!l){l=$("<input />",{class:"mb-10 form-control",placeholder:V({en_us:"Transparent",pt_br:"Transparente"}),type:"text",name:"rgb"}),u.prepend(l);var a={theme:"bootstrap",swatches:[],change:function(t){if(m[c].options)for(var n=0;n<m[c].options.length;n++){var i=m[c].options[n],e=i.colors;e&&e[0]===t&&f.typeahead("val",i.text)}}};if(m[c].options)for(var o=0;o<m[c].options.length;o++){var r=m[c].options[o].colors;r&&r.length&&a.swatches.push(r[0])}l.minicolors(a)}l.focus()}else l&&(l.minicolors("destroy").remove(),l=null),f.focus()}else f.typeahead("val",""),1<v&&w(s);setTimeout(function(){d=!1},100)}}).keyup(function(){""!==i.val()?e&&(u.fadeIn(),e=!1,1===v&&$("#t"+R+"-add-option-header").fadeIn()):e||(u.fadeOut(),e=!0,1===v&&$("#t"+R+"-add-option-header").fadeOut())}).keydown(function(t){switch(t.which){case 9:case 13:d||setTimeout(function(){i.trigger("change")},100)}}),f.keydown(function(t){switch(t.which){case 9:setTimeout(function(){i.focus()},100);break;case 13:g(s,f,c)}}),a(i,"grids",substringMatcher(function(){var t=[];for(var n in m)m.hasOwnProperty(n)&&t.push(m[n].title);return t}())),a(f,"options",substringMatcher(function(){return p})),s.find(".remove-grid").click(function(){w(s)}),s.find(".add-option").click(function(){g(s,f,c)}),1===++v&&$("#t"+R+"-grids-list-header").slideDown(),s.slideDown(400,function(){t||i.focus(),setTimeout(function(){window.Sortable.create(s.find(".badges-list")[0],{onUpdate:function(t){var n=h[c],i=n.splice(t.oldIndex,1)[0];i&&n.splice(t.newIndex,0,i),b()}})},200)})}},g=function(t,n,i){var e=n.val().split(",");n.typeahead("val","").focus();for(var a=0;a<e.length;a++){var o=e[a].trim();if(""!==o){var r,s;if(i){var l,c,d=normalizeString(o);if(m[i]&&m[i].options)for(l=0;l<m[i].options.length;l++){var u=m[i].options[l];if(d===normalizeString(u.text)){d=u.option_id;break}}for(s=h[i],l=0;l<s.length;l++)if(d===s[l].option_id){c=!0;break}if(c)continue;r=s.length,s[r]={option_id:d,text:o}}var f=$("<li />",{html:'<span class="i-drag white"></span>'+o+'<i class="fa fa-times"></i>'});t.find(".badges-list").append(f),f.find(".fa-times").click(function(){f.remove(),void 0!==r&&(s.splice(r,1),b())}),b()}}},P=$("#t"+R+"-variations-list"),s=function(t){return P.children(":not(.disabled)").index(t)},T=function(i,e){return function(){var t,n=J();$(this).is(":checked")?(i.removeClass("disabled"),t=s(i),n.variations.splice(t,0,JSON.parse($(this).data("variation"))),e.removeAttr("disabled")):(t=s(i),$(this).data("variation",JSON.stringify(n.variations[t])),n.variations.splice(t,1),i.addClass("disabled"),e.attr("disabled",!0)),G(n,!0)}},j=function(t){return function(){d(s(t))}},b=function(){var x,S={};for(x in h){var t=h[x];t&&t.length&&(S[x]=t)}P.slideUp(400,function(){$(this).html("");var t,n,i,e=J(),a=getCombinations(S),o=[];for(t=0;t<a.length;t++){var r=a[t],s="",l=new RegExp("^"+A+"(\\s\\/\\s.*)$"),c=A,d={};for(x in r)if(r.hasOwnProperty(x)){var u=r[x].text;c+=" / "+u,s+="<span>"+u+"</span>",d[x]=[{text:u}]}var f=$("<li />",{html:'<div class="flexbox align-items-center"><div><div class="custom-control custom-checkbox"><input type="checkbox" class="custom-control-input" checked ><label class="custom-control-label fw-400 colored"> </label></div></div><button class="btn btn-light" type="button"><i class="fa fa-cog"></i><span class="i18n"> <span data-lang="en_us">Edit variation</span><span data-lang="pt_br">Editar variação</span></span></button></div>'});f.find("label").html(s);var p=f.find("button");p.click(j(f)),f.find('input[type="checkbox"]').change(T(f,p)),P.append(f),f.slideDown();var h={};if(e.variations){var v=o.length,m={matches:0,index:null};for(n=0;n<e.variations.length;n++){var g=e.variations[n].specifications,b=0;for(var w in g)if(g.hasOwnProperty(w)&&d.hasOwnProperty(w)){var k=!1;if((i=g[w].length)===d[w].length){for(var _=0;_<i;_++)if(g[w][_].text!==d[w][_].text){k=!0;break}}else k=!0;if(k){b=0;break}b++}if(!(b<m.matches)){if(b===m.matches){if(n!==v)continue;m.sameIndex=!0}if(m.index=n,b===Object.keys(d).length&&b===Object.keys(g).length){m.sameSpecs=!0;break}}}null!==m.index&&(h=e.variations[m.index],m.sameSpecs||(delete h._id,delete h.specifications,m.sameIndex||delete h.sku))}h._id||(h._id=objectIdPad(O,""+I),I++,h.specifications=d),h.name&&!l.test(h.name)||(h.name=c),o.push(h)}for(""===U&&"function"==typeof z&&z(),i=o.length,t=0;t<i;t++)if(!o[t].sku){for(var y=null;!y;)for(y=U+"-"+randomInt(100,999)+"-"+(t+1),n=0;n<i.length;n++)if(y===o[n].sku){y=null;break}o[t].sku=y}$(this).slideDown(),e.variations=o,G(e,!0)})};$("#t"+R+"-add-grid").click(function(){n()});var w=function(t){t.slideUp(400,function(){$(this).remove()}),0===--v&&$("#t"+R+"-grids-list-header, #t"+R+"-add-option-header").slideUp()},i=function(t){var n,i=J(),e=i[t]||"",a=i.variations;if(n="name"===t?A:U,a){for(var o=new RegExp("^"+n),r=0;r<a.length;r++){var s=a[r];"string"==typeof s[t]&&(s[t]=s[t].replace(o,e))}G(i,!0)}"name"===t?A=e:U=e},U=J().sku||"",e=t.find('input[name="sku"]');e.click(function(){$(this).select()}).change(function(){i("sku")});var l=function(){for(var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZ",i=0;i<3;i++)t+=n.charAt(Math.floor(Math.random()*n.length));t+=randomInt(1e3,9999),e.val(t).trigger("change"),c(t,function(){l()})};$("#t"+R+"-random-sku").click(l);var z,c=function(t,a){t&&window.callApi("products.json?sku="+encodeURIComponent(t),"GET",function(t,n){if(!t){var i=n.result,e=i.length;e&&(1<e||i[0]._id!==f.resourceId)&&("function"==typeof a?a():app.toast({en_us:"There is another product registered with this same SKU",pt_br:"Existe outro produto cadastrado com este mesmo SKU"}))}})};f.resourceId?""!==U&&c(U):(z=function(){""===U&&l(),t.off("change",'input[name="name"]',z),z=null},t.on("change",'input[name="name"]',z)),setTimeout(function(){t.find('select[name="brands"],select[name="categories"]').each(function(){var e=$(this).prev(".dropdown-menu");if(e.length){var a=$(this);e.find(".bs-searchbox input").keydown(function(){var i=$(this);setTimeout(function(){var t=e.find(".dropdown-menu > .no-results");if(t.length){var n=$("<button />",{class:"btn btn-outline btn-secondary btn-sm btn-block",type:"button",html:'<i class="fa fa-plus"></i> '+V({en_us:"Add",pt_br:"Adicionar"}),click:function(){!function(i,n){var e=function(t){return JSON.stringify({_id:t,name:n})},a=$("<option />",{text:n,selected:!0,value:e(objectIdPad(O,""+I))});I++,i.append(a).selectpicker("refresh").trigger("change");var t=i.attr("name");window.callApi(t+".json","POST",function(t,n){t||(a.val(e(n._id)),i.trigger("change"))},{name:n})}(a,i.val())}});t.html(n)}},300)})}})},400);var A=J().name||"",k=V({en_us:"New product",pt_br:"Novo produto"}),_=t.find('input[name="name"]');_.attr("placeholder",V({en_us:"Long Sleeve Polo Shirt",pt_br:"Camisa Polo Manga Longa"})).click(function(){$(this).val()===k&&$(this).val("").trigger("change")}).change(function(){i("name")}),t.find('input[name="variations.name"]').attr("placeholder",V({en_us:"Long Sleeve Polo Shirt / M / Red",pt_br:"Camisa Polo Manga Longa / M / Vermelho"})),f.formSetup();var y=0,x=t.children("#t"+R+"-product-fields"),S=t.children("#t"+R+"-variation-fields");$("#t"+R+"-back-to-product").click(function(){S.slideUp(400,function(){x.slideDown()})});var d=function(c){var d=J(),u=d.variations;if(u&&0<=c&&u.length>c){var f,p;d.name||_.val(k).trigger("change"),d.sku||l(),y=c;var t=[];for(p=0;p<u.length;p++)p!==c&&(f=u[p]).sku&&4<Object.keys(f).length&&t.push(f.sku);if(t.length){var n=[];for(p=0;p<t.length;p++)n.push($("<a />",{class:"dropdown-item",text:t[p],href:"javascript:;",click:function(t){return function(){L(t)}}(p)}));D.html(n),E.show()}else E.hide();var h=(f=u[c]).specifications,v=S;x.slideUp(400,function(){var t="";for(var n in h){var i=h[n];if(i){for(t+='<h4><small class="subtitle m-0">'+m[n].title+"</small>",p=0;p<i.length;p++)t+=" <small>·</small> "+i[p].text;t+="</h4>"}}v.find("#t"+R+"-variation-specs").html(t),c<u.length-1?C.removeAttr("disabled"):C.attr("disabled",!0),0<c?M.removeAttr("disabled"):M.attr("disabled",!0);var e=d.pictures;if(e&&e.length){var a=[];for(p=0;p<e.length;p++){var o,r=e[p];o=r.hasOwnProperty("normal")?r.normal.url:r.zoom.url;var s=r._id,l={html:'<img src="'+o+'">',click:function(t){return function(){f.picture_id=t,G(J(),!0),$(this).addClass("selected").siblings(".selected").removeClass("selected")}}(s)};f.picture_id===s&&(l.class="selected"),a.push($("<span />",l))}N.show().find(".images-list").html(a)}else N.hide();v.find("input,select").data("object-id",f._id).each(function(){$(this).val($(this).data("default")||"")}),setupInputValues(v,f,"variations."),v.slideDown()})}},u=function(t){S.slideUp(400,function(){d(y+t)})},C=S.find("#t"+R+"-next-variation"),M=S.find("#t"+R+"-prev-variation");C.click(function(){u(1)}),M.click(function(){u(-1)});var E=S.find("#t"+R+"-copy-variation"),D=E.children("div"),L=function(t){var n=J(),i=n.variations;if(i){var e=i[t],a=i[y];if(e&&a){for(var o in e)if(e.hasOwnProperty(o))switch(o){case"_id":case"sku":case"specifications":case"name":break;default:a[o]=e[o]}G(n,!0),setupInputValues(S,n)}}};S.find('input[name="variations.name"]').focus(function(){""===$(this).val()&&$(this).val(cutString(A,100)).select()}),S.find('input[name="variations.sku"]').click(function(){var t=$(this).val();0===t.indexOf(U)?$(this).selectRange(U.length,t.length):$(this).select()});var N=S.find("#t"+R+"-variation-image")}}();