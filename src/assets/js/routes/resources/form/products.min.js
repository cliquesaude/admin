/*!
 * Copyright 2018 E-Com Club
 */
!function(){"use strict";var a=window.tabId,b=window.Tabs[a],c=b.commit,d=function(){return b.data},e=window.i18n;b.continue=function(){var f=b.$form,g=randomObjectId(),h=0,i={material:{title:"Material"},pattern:{title:e({en_us:"Pattern",pt_br:"Modelo"})},size:{title:e({en_us:"Size",pt_br:"Tamanho"})},colors:{title:e({en_us:"Color",pt_br:"Cor"})}},j={};window.callApi("grids.json?fields=title,grid_id,options","GET",function(a,b){if(!a)for(var c=0;c<b.result.length;c++){var d=b.result[c],e=normalizeString(d.title);for(var f in i)i.hasOwnProperty(f)&&f!==d.grid_id&&normalizeString(i[f].title)===e&&delete i[f];i[d.grid_id]=d}});var k=function(){var a=[];for(var b in i)i.hasOwnProperty(b)&&a.push(i[b].title);return a},l=function(a){var b=[];if(i[a]){var c=i[a].options;if(void 0!==c)for(var d=0;d<c.length;d++)b.push(c[d].text)}return b},m=function(a,b,c){a.typeahead({hint:!0,highlight:!0,minLength:1},{name:b,source:c})},n=$("#"+a+"-grids-list"),o='<div class="row gap-2"><div class="col-6"><div class="flexbox align-items-center"><div class="i-drag"></div><div class="input-group"><div class="input-group-prepend"><button class="btn btn-light remove-grid" type="button"><i class="fa fa-trash"></i></button></div><input class="form-control" type="text" name="grid" placeholder="'+e({en_us:"Size",pt_br:"Tamanho"})+'"></div></div></div><div class="col-6 hidden option-block"><div class="input-group"><input class="form-control" type="text" name="option" placeholder="GG"><div class="input-group-append"><button class="btn btn-light add-option" type="button"><i class="fa fa-plus"></i></button></div></div></div></div><ul class="hide-empty badges-list"></ul>';window.Sortable.create(n[0],{onUpdate:function(a){var b=Object.keys(j),c=b.splice(a.oldIndex,1)[0];c&&b.splice(a.newIndex,0,c);for(var d={},e=0;e<b.length;e++){var f=b[e];d[f]=j[f]}j=d,w()}});var p=0,q=function(b){var c=n.find('input[name="grid"]').filter(function(){return""===$(this).val()});if(c.length)return void c.focus();var d=$("<li />",{html:o});n.append(d);var e,f,g=d.find('input[name="grid"]'),h=d.find(".option-block"),q=h.find('input[name="option"]'),s=!0,t=[];g.change(function(){if(!f){f=!0;var a=$(this).val().trim();if(""!==a){var b;e&&(b=e),e=normalizeString(a);for(var c in i)if(i.hasOwnProperty(c)&&normalizeString(i[c].title)===e){e=c;break}if(b!==e){if(t=l(e),j.hasOwnProperty(e)){for(var g=2;j.hasOwnProperty(e+"_"+g);)g++;e+="_"+g}b?(j[e]=j[b],delete j[b]):j[e]=[],i.hasOwnProperty(e)||(i[e]={title:a}),$(this).data("grid-id",e)}q.focus()}else q.val(""),p>1&&x(d);setTimeout(function(){f=!1},100)}}).keyup(function(){""!==g.val()?s&&(h.fadeIn(),s=!1,1===p&&$("#"+a+"-add-option-header").fadeIn()):s||(h.fadeOut(),s=!0,1===p&&$("#"+a+"-add-option-header").fadeOut())}).keydown(function(a){switch(a.which){case 9:case 13:f||setTimeout(function(){g.trigger("change")},100)}}),q.click(function(){$(this).select()}).keydown(function(a){switch(a.which){case 9:setTimeout(function(){g.focus()},100);break;case 13:r(d,q,e)}}),m(g,"grids",substringMatcher(k())),m(q,"options",substringMatcher(function(){return t})),d.find(".remove-grid").click(function(){x(d)}),d.find(".add-option").click(function(){r(d,q,e)}),p++,1===p&&$("#"+a+"-grids-list-header").slideDown(),d.slideDown(400,function(){b||g.focus(),setTimeout(function(){window.Sortable.create(d.find(".badges-list")[0],{onUpdate:function(a){var b=j[e],c=b.splice(a.oldIndex,1)[0];c&&b.splice(a.newIndex,0,c),w()}})},200)})},r=function(a,b,c){var d=b.val().split(",");b.val("").focus();for(var e=0;e<d.length;e++){var f=d[e].trim();if(""!==f){var g,h;if(c){var k,l=normalizeString(f);if(i[c]&&i[c].options)for(k=0;k<i[c].options.length;k++){var m=i[c].options[k];if(l===normalizeString(m.text)){l=m.option_id;break}}h=j[c];var n;for(k=0;k<h.length;k++)if(l===h[k].option_id){n=!0;break}if(n)continue;g=h.length,h[g]={option_id:l,text:f}}var o=$("<li />",{html:'<span class="i-drag white"></span>'+f+'<i class="fa fa-times"></i>'});a.find(".badges-list").append(o),o.find(".fa-times").click(function(){o.remove(),void 0!==g&&(h.splice(g,1),w())}),w()}}},s=$("#"+a+"-variations-list"),t=function(a){return s.children(":not(.disabled)").index(a)},u=function(a,b){return function(){var e,f=d();$(this).is(":checked")?(a.removeClass("disabled"),e=t(a),f.variations.splice(e,0,JSON.parse($(this).data("variation"))),b.removeAttr("disabled")):(e=t(a),$(this).data("variation",JSON.stringify(f.variations[e])),f.variations.splice(e,1),a.addClass("disabled"),b.attr("disabled",!0)),c(f,!0)}},v=function(a){return function(){G(t(a))}},w=function(){var a,b={};for(a in j){var e=j[a];e&&e.length&&(b[a]=e)}s.slideUp(400,function(){$(this).html("");var e,f,i,j=d(),k=getCombinations(b),l=[];for(e=0;e<k.length;e++){var m=k[e],n="",o={};for(a in m)if(m.hasOwnProperty(a)){var p=m[a].text;n+="<span>"+p+"</span>",o[a]=[{text:p}]}var q=$("<li />",{html:'<div class="flexbox align-items-center"><div><div class="custom-control custom-checkbox"><input type="checkbox" class="custom-control-input" checked ><label class="custom-control-label fw-400 colored"> </label></div></div><button class="btn btn-light" type="button"><i class="fa fa-cog"></i><span class="i18n"> <span data-lang="en_us">Edit variation</span><span data-lang="pt_br">Editar variação</span></span></button></div>'});q.find("label").html(n);var r=q.find("button");r.click(v(q)),q.find('input[type="checkbox"]').change(u(q,r)),s.append(q),q.slideDown();var t={};if(j.variations){var w=l.length,x={matches:0,index:null};for(f=0;f<j.variations.length;f++){var z=j.variations[f].specifications,A=0;for(var C in z)if(z.hasOwnProperty(C)&&o.hasOwnProperty(C)){i=z[C].length;var D=!1;if(i===o[C].length){for(var E=0;E<i;E++)if(z[C][E].text!==o[C][E].text){D=!0;break}}else D=!0;if(D){A=0;break}A++}if(!(A<x.matches)){if(A===x.matches){if(f!==w)continue;x.sameIndex=!0}if(x.index=f,A===Object.keys(o).length){x.sameSpecs=!0;break}}}null!==x.index&&(t=j.variations[x.index],x.sameSpecs||(delete t._id,delete t.specifications,x.sameIndex||delete t.sku))}t._id||(t._id=objectIdPad(g,""+h),h++,t.specifications=o),l.push(t)}if(y||"function"!=typeof B||B(),y)for(i=l.length,e=0;e<i;e++)if(!l[e].sku){for(var F=null;!F;)for(F=y+"-"+randomInt(100,999)+"-"+e,f=0;f<i.length;f++)if(F===l[f].sku){F=null;break}l[e].sku=F}$(this).slideDown(),j.variations=l,c(j,!0)})};$("#"+a+"-add-grid").click(function(){q()});var x=function(b){b.slideUp(400,function(){$(this).remove()}),0===--p&&$("#"+a+"-grids-list-header, #"+a+"-add-option-header").slideUp()},y=d().sku,z=f.find('input[name="sku"]');z.click(function(){$(this).select()}).change(function(){var a=d(),b=a.sku,e=a.variations;if(b&&e){for(var f=new RegExp("^"+y+"(-[0-9]{3}-[0-9]+)$"),g=0;g<e.length;g++){var h=e[g];"string"==typeof h.sku&&(h.sku=h.sku.replace(f,b+"$1"))}c(a,!0)}y=b});var A=function(){for(var a="",b="ABCDEFGHIJKLMNOPQRSTUVWXYZ",c=0;c<3;c++)a+=b.charAt(Math.floor(Math.random()*b.length));a+=randomInt(1e3,9999),z.val(a).trigger("change"),C(a,function(){A()})};$("#"+a+"-random-sku").click(A);var B,C=function(a,c){a&&window.callApi("products.json?sku="+encodeURIComponent(a),"GET",function(a,d){if(!a){var e=d.result,f=e.length;f&&(f>1||e[0]._id!==b.resourceId)&&("function"==typeof c?c():app.toast({en_us:"There is another product registered with this same SKU",pt_br:"Existe outro produto cadastrado com este mesmo SKU"}))}})};b.resourceId?y&&C(y):(B=function(){y||A(),f.off("change",'input[name="name"]',B),B=null},f.on("change",'input[name="name"]',B)),setTimeout(function(){var a=function(a,b){var c=function(a){return JSON.stringify({_id:a,name:b})},d=$("<option />",{text:b,selected:!0,value:c(objectIdPad(g,""+h))});h++,a.append(d).selectpicker("refresh").trigger("change");var e=a.attr("name"),f=function(b,e){b||(d.val(c(e._id)),a.trigger("change"))};window.callApi(e+".json","POST",f,{name:b})};f.find('select[name="brands"],select[name="categories"]').each(function(){var b=$(this).prev(".dropdown-menu");if(b.length){var c=$(this);b.find(".bs-searchbox input").keydown(function(){var d=$(this);setTimeout(function(){var f=b.find(".dropdown-menu > .no-results");if(f.length){var g=$("<button />",{class:"btn btn-outline btn-secondary btn-sm btn-block",type:"button",html:'<i class="fa fa-plus"></i> '+e({en_us:"Add",pt_br:"Adicionar"}),click:function(){a(c,d.val())}});f.html(g)}},300)})}})},400),f.find('input[name="name"]').attr("placeholder",e({en_us:"Long Sleeve Polo Shirt",pt_br:"Camisa Polo Manga Longa"})),f.find('input[name="variations.name"]').attr("placeholder",e({en_us:"Long Sleeve Polo Shirt: size M",pt_br:"Camisa Polo Manga Longa: tamanho M"})),b.formSetup();var D=0,E=f.children("#"+a+"-product-fields"),F=f.children("#"+a+"-variation-fields");$("#"+a+"-back-to-product").click(function(){F.slideUp(400,function(){E.slideDown()})});var G=function(b){var c=d(),e=c.variations;if(e&&b>=0&&e.length>b){D=b;var f,g,h=[];for(g=0;g<e.length;g++)g!==b&&(f=e[g],f.sku&&Object.keys(f).length>3&&h.push(f.sku));if(h.length){var j=[];for(g=0;g<h.length;g++)j.push($("<a />",{class:"dropdown-item",text:h[g],href:"javascript:;",click:function(a){return function(){M(a)}}(g)}));L.html(j),K.show()}else K.hide();f=e[b];var k=f.specifications,l=F;E.slideUp(400,function(){var c="";for(var d in k){var h=k[d];if(h){for(c+='<h4><small class="subtitle m-0">'+i[d].title+"</small>",g=0;g<h.length;g++)c+=" <small>·</small> "+h[g].text;c+="</h4>"}}l.find("#"+a+"-variation-specs").html(c),b<e.length-1?I.removeAttr("disabled"):I.attr("disabled",!0),b>0?J.removeAttr("disabled"):J.attr("disabled",!0),l.find("input,select").data("object-id",f._id).each(function(){$(this).val($(this).data("default")||"")}),setupInputValues(l,f,"variations."),l.slideDown()})}},H=function(a){F.slideUp(400,function(){G(D+a)})},I=F.find("#"+a+"-next-variation"),J=F.find("#"+a+"-prev-variation");I.click(function(){H(1)}),J.click(function(){H(-1)});var K=F.find("#"+a+"-copy-variation"),L=K.children("div"),M=function(a){var b=d(),e=b.variations;if(e){var f=e[a],g=e[D];if(f&&g){for(var h in f)"_id"!==h&&"sku"!==h&&"specifications"!==h&&f[h]&&(g[h]=f[h]);c(b,!0),setupInputValues(F,b)}}};F.find('input[name="variations.name"]').focus(function(){if(""===$(this).val()){var a=d().name;a&&$(this).val(cutString(a,100)).select()}})}}();