!function(){"use strict";var J=window.tabId,f=window.Tabs[J],V=f.commit,B=function(){return f.data},K=window.i18n;f.continue=function(){var t=f.$form,P=randomObjectId(),T=0,m={material:{title:"Material"},pattern:{title:K({en_us:"Pattern",pt_br:"Modelo"})},size:{title:K({en_us:"Size",pt_br:"Tamanho"})},colors:{title:K({en_us:"Colors",pt_br:"Cores"}),options:[{option_id:"blue",text:K({en_us:"Blue",pt_br:"Azul"}),colors:["#0000ff"]},{option_id:"white",text:K({en_us:"White",pt_br:"Branco"}),colors:["#ffffff"]}]}},g={};window.callApi("grids.json?fields=title,grid_id,options","GET",function(t,i){if(!t)for(var n=0;n<i.result.length;n++){var e=i.result[n],a=normalizeString(e.title);for(var o in m)m.hasOwnProperty(o)&&o!==e.grid_id&&normalizeString(m[o].title)===a&&delete m[o];m[e.grid_id]=e}});var a=function(t,i,n){t.typeahead({hint:!0,highlight:!0,minLength:1},{name:i,source:n})},o=$("#t"+J+"-grids-list"),r='<div class="row gap-2"><div class="col-6"><div class="flexbox align-items-center"><div class="i-drag"></div><div class="input-group"><div class="input-group-prepend"><button class="btn btn-light remove-grid" type="button"><i class="fa fa-trash"></i></button></div><input class="form-control" type="text" name="grid" placeholder="'+K({en_us:"Size",pt_br:"Tamanho"})+'"></div></div></div><div class="col-6 hidden option-block"><div class="input-group"><input class="form-control" type="text" name="option" placeholder="GG"><div class="input-group-append"><button class="btn btn-light add-option" type="button"><i class="fa fa-plus"></i></button></div></div></div></div><ul class="hide-empty badges-list"></ul>';window.Sortable.create(o[0],{onUpdate:function(t){var i=Object.keys(g),n=i.splice(t.oldIndex,1)[0];n&&i.splice(t.newIndex,0,n);for(var e={},a=0;a<i.length;a++){var o=i[a];e[o]=g[o]}g=e,w()}});var b=0,i=function(t){var i=o.find('input[name="grid"]').filter(function(){return""===$(this).val()});if(i.length)i.focus();else{var l=$("<li />",{html:r});o.append(l);var c,d,u,n=l.find('input[name="grid"]'),f=l.find(".option-block"),p=f.find('input[name="option"]'),e=!0,v=[],h=function(){s(l,p,c,d)};n.change(function(){if(!u){u=!0;var t=$(this).val().trim();if(""!==t){var i;for(var n in d&&(i=d),d=normalizeString(t),m)if(m.hasOwnProperty(n)&&normalizeString(m[n].title)===d){d=n;break}if(i!==d){if(v=function(t){var i=[];if(m[t]){var n=m[t].options;if(void 0!==n)for(var e=0;e<n.length;e++)i.push(n[e].text)}return i}(d),g.hasOwnProperty(d)){for(var e=2;g.hasOwnProperty(d+"_"+e);)e++;d+="_"+e}i?(g[d]=g[i],delete g[i]):g[d]=[],m.hasOwnProperty(d)||(m[d]={title:t}),$(this).data("grid-id",d)}if("colors"===d){if(!c){c=$("<input />",{class:"mb-10 form-control",placeholder:K({en_us:"Transparent",pt_br:"Transparente"}),type:"text",name:"rgb",keydown:function(t){switch(t.which){case 9:case 13:setTimeout(function(){p.focus()},100)}}}),f.prepend(c);var a={theme:"bootstrap",position:"top left",swatches:[],change:function(t){if(m[d].options)for(var i=0;i<m[d].options.length;i++){var n=m[d].options[i],e=n.colors;if(e&&e[0]===t)return p.typeahead("val",n.text),void h()}}};if(m[d].options)for(var o=0;o<m[d].options.length;o++){var r=m[d].options[o].colors;r&&r.length&&a.swatches.push(r[0])}c.minicolors(a);var s=c.nextAll(".minicolors-panel");s.css("top",-(s.height()+8)+"px")}c.focus()}else c&&(c.minicolors("destroy").remove(),c=null),p.focus()}else p.typeahead("val",""),1<b&&k(l,d);setTimeout(function(){u=!1},100)}}).keyup(function(){""!==n.val()?e&&(f.fadeIn(),e=!1,1===b&&$("#t"+J+"-add-option-header").fadeIn()):e||(f.fadeOut(),e=!0,1===b&&$("#t"+J+"-add-option-header").fadeOut())}).keydown(function(t){switch(t.which){case 9:case 13:u||setTimeout(function(){n.trigger("change")},100)}}),p.keydown(function(t){switch(t.which){case 9:setTimeout(function(){n.focus()},100);break;case 13:h()}}),a(n,"grids",substringMatcher(function(){var t=[];for(var i in m)m.hasOwnProperty(i)&&t.push(m[i].title);return t}())),a(p,"options",substringMatcher(function(){return v})),l.find(".remove-grid").click(function(){k(l,d)}),l.find(".add-option").click(function(){h()}),1===++b&&$("#t"+J+"-grids-list-header").slideDown(),l.slideDown(400,function(){t||n.focus(),setTimeout(function(){window.Sortable.create(l.find(".badges-list")[0],{onUpdate:function(t){var i=g[d],n=i.splice(t.oldIndex,1)[0];n&&i.splice(t.newIndex,0,n),w()}})},200)})}},s=function(t,i,n,e){var a=i.val().split(",");i.typeahead("val","").focus();for(var o=0;o<a.length;o++){var r=a[o].trim();if(""!==r){var s,l;if(e){var c,d,u,f=normalizeString(r);if(m[e]&&m[e].options)for(d=0;d<m[e].options.length;d++)if(c=m[e].options[d],f===normalizeString(c.text)){f=c.option_id;break}for(l=g[e],d=0;d<l.length;d++)if(f===l[d].option_id){u=!0;break}if(u)continue;s=l.length,c={option_id:f,text:r},n&&(c.value=n.minicolors("value")),l[s]=c}var p=$("<li />",{html:'<span class="i-drag white"></span>'+r+'<i class="fa fa-times"></i>'});t.find(".badges-list").append(p),p.find(".fa-times").click(function(){p.remove(),void 0!==s&&(l.splice(s,1),w())}),w()}}},j=$("#t"+J+"-variations-list"),l=function(t){return j.children(":not(.disabled)").index(t)},A=function(e,a){return function(){var t,i=B();if($(this).is(":checked")){e.removeClass("disabled"),t=l(e);var n=JSON.parse($(this).data("variation"));i.variations?i.variations.splice(t,0,n):i.variations=[n],a.removeAttr("disabled")}else t=l(e),$(this).data("variation",JSON.stringify(i.variations[t])),1<i.variations.length?i.variations.splice(t,1):delete i.variations,e.addClass("disabled"),a.attr("disabled",!0);V(i,!0)}},U=function(t){return function(){d(l(t))}},w=function(){var O,I={};for(O in g){var t=g[O];t&&t.length&&(I[O]=t)}j.slideUp(400,function(){$(this).html("");var t,i,n,e=B(),a=getCombinations(I),o=[];for(t=0;t<a.length;t++){var r=a[t],s="",l=new RegExp("^"+M+"(\\s\\/\\s.*)$"),c=M,d={};for(O in r)if(r.hasOwnProperty(O)){var u=r[O].text;c+=" / "+u,s+="<span>"+u+"</span>";var f={text:u},p=r[O].value;p&&(f.value=p),d[O]=[f]}var v=$("<li />",{html:'<div class="flexbox align-items-center"><div><div class="custom-control custom-checkbox"><input type="checkbox" class="custom-control-input" checked ><label class="custom-control-label fw-400 colored"> </label></div></div><button class="btn btn-light" type="button"><i class="fa fa-cog"></i><span class="i18n"> <span data-lang="en_us">Edit variation</span><span data-lang="pt_br">Editar variação</span></span></button></div>'});v.find("label").html(s);var h=v.find("button");h.click(U(v)),v.find('input[type="checkbox"]').change(A(v,h)),j.append(v),v.slideDown();var m={};if(e.variations){var g=o.length,b={matches:0,index:null};for(i=0;i<e.variations.length;i++){var w=e.variations[i].specifications,k=0;for(var _ in w)if(w.hasOwnProperty(_)&&d.hasOwnProperty(_)){var x=!1;if((n=w[_].length)===d[_].length){for(var y=0;y<n;y++)if(w[_][y].text!==d[_][y].text){x=!0;break}}else x=!0;if(x){k=0;break}k++}if(!(k<b.matches)){if(k===b.matches){if(i!==g)continue;b.sameIndex=!0}if(b.index=i,k===Object.keys(d).length&&k===Object.keys(w).length){b.sameSpecs=!0;break}}}null!==b.index&&(m=e.variations[b.index],b.sameSpecs||(delete m._id,delete m.specifications,b.sameIndex||delete m.sku))}m._id||(m._id=objectIdPad(P,""+T),T++,m.specifications=d),m.name&&!l.test(m.name)||(m.name=c),o.push(m)}for(""===z&&"function"==typeof C&&C(),n=o.length,t=0;t<n;t++)if(!o[t].sku){for(var S=null;!S;)for(S=z+"-"+randomInt(100,999)+"-"+(t+1),i=0;i<n.length;i++)if(S===o[i].sku){S=null;break}o[t].sku=S}$(this).slideDown(),e.variations=o,V(e,!0)})};$("#t"+J+"-add-grid").click(function(){i()});var k=function(t,i){t.slideUp(400,function(){$(this).remove()}),0===--b&&$("#t"+J+"-grids-list-header, #t"+J+"-add-option-header").slideUp(),delete g[i],w()},n=function(t){var i,n=B(),e=n[t]||"",a=n.variations;if(i="name"===t?M:z,a){for(var o=new RegExp("^"+i),r=0;r<a.length;r++){var s=a[r];"string"==typeof s[t]&&(s[t]=s[t].replace(o,e))}V(n,!0)}"name"===t?M=e:z=e},z=B().sku||"",e=t.find('input[name="sku"]');e.click(function(){$(this).select()}).change(function(){n("sku")});var _=function(){for(var t="",i="ABCDEFGHIJKLMNOPQRSTUVWXYZ",n=0;n<3;n++)t+=i.charAt(Math.floor(Math.random()*i.length));t+=randomInt(1e3,9999),e.val(t).trigger("change"),c(t,function(){_()})};$("#t"+J+"-random-sku").click(_);var C,c=function(t,a){t&&window.callApi("products.json?sku="+encodeURIComponent(t),"GET",function(t,i){if(!t){var n=i.result,e=n.length;e&&(1<e||n[0]._id!==f.resourceId)&&("function"==typeof a?a():app.toast({en_us:"There is another product registered with this same SKU",pt_br:"Existe outro produto cadastrado com este mesmo SKU"}))}})};f.resourceId?""!==z&&c(z):(C=function(){""===z&&_(),t.off("change",'input[name="name"]',C),C=null},t.on("change",'input[name="name"]',C)),setTimeout(function(){t.find('select[name="brands"],select[name="categories"]').each(function(){var e=$(this).prev(".dropdown-menu");if(e.length){var a=$(this);e.find(".bs-searchbox input").keydown(function(){var n=$(this);setTimeout(function(){var t=e.find(".dropdown-menu > .no-results");if(t.length){var i=$("<button />",{class:"btn btn-outline btn-secondary btn-sm btn-block",type:"button",html:'<i class="fa fa-plus"></i> '+K({en_us:"Add",pt_br:"Adicionar"}),click:function(){!function(n,i){var e=function(t){return JSON.stringify({_id:t,name:i})},a=$("<option />",{text:i,selected:!0,value:e(objectIdPad(P,""+T))});T++,n.append(a).selectpicker("refresh").trigger("change");var t=n.attr("name");window.callApi(t+".json","POST",function(t,i){t||(a.val(e(i._id)),n.trigger("change"))},{name:i})}(a,n.val())}});t.html(i)}},300)})}})},400);var M=B().name||"",x=K({en_us:"New product",pt_br:"Novo produto"}),y=t.find('input[name="name"]');y.attr("placeholder",K({en_us:"Long Sleeve Polo Shirt",pt_br:"Camisa Polo Manga Longa"})).click(function(){$(this).val()===x&&$(this).val("").trigger("change")}).change(function(){n("name")}),t.find('input[name="variations.name"]').attr("placeholder",K({en_us:"Long Sleeve Polo Shirt / M / Red",pt_br:"Camisa Polo Manga Longa / M / Vermelho"})),f.formSetup();var S=0,O=t.children("#t"+J+"-product-fields"),I=t.children("#t"+J+"-variation-fields");$("#t"+J+"-back-to-product").click(function(){I.slideUp(400,function(){O.slideDown()})});var d=function(c){var d=B(),u=d.variations;if(u&&0<=c&&u.length>c){var f,p;d.name||y.val(x).trigger("change"),d.sku||_(),S=c;var t=[];for(p=0;p<u.length;p++)p!==c&&(f=u[p]).sku&&4<Object.keys(f).length&&t.push(f.sku);if(t.length){var i=[];for(p=0;p<t.length;p++)i.push($("<a />",{class:"dropdown-item",text:t[p],href:"javascript:;",click:function(t){return function(){R(t)}}(p)}));N.html(i),L.show()}else L.hide();var v=(f=u[c]).specifications,h=I;O.slideUp(400,function(){var t="";for(var i in v){var n=v[i];if(n){for(t+='<h4><small class="subtitle m-0">'+m[i].title+"</small>",p=0;p<n.length;p++)t+=" <small>·</small> "+n[p].text;t+="</h4>"}}h.find("#t"+J+"-variation-specs").html(t),c<u.length-1?E.removeAttr("disabled"):E.attr("disabled",!0),0<c?D.removeAttr("disabled"):D.attr("disabled",!0);var e=d.pictures;if(e&&e.length){var a=[];for(p=0;p<e.length;p++){var o,r=e[p];o=r.hasOwnProperty("normal")?r.normal.url:r.zoom.url;var s=r._id,l={html:'<img src="'+o+'">',click:function(t){return function(){f.picture_id=t,V(B(),!0),$(this).addClass("selected").siblings(".selected").removeClass("selected")}}(s)};f.picture_id===s&&(l.class="selected"),a.push($("<span />",l))}G.show().find(".images-list").html(a)}else G.hide();h.find("input,select").data("object-id",f._id).each(function(){$(this).val($(this).data("default")||"")}),setupInputValues(h,f,"variations."),h.slideDown()})}},u=function(t){I.slideUp(400,function(){d(S+t)})},E=I.find("#t"+J+"-next-variation"),D=I.find("#t"+J+"-prev-variation");E.click(function(){u(1)}),D.click(function(){u(-1)});var L=I.find("#t"+J+"-copy-variation"),N=L.children("div"),R=function(t){var i=B(),n=i.variations;if(n){var e=n[t],a=n[S];if(e&&a){for(var o in e)if(e.hasOwnProperty(o))switch(o){case"_id":case"sku":case"specifications":case"name":break;default:a[o]=e[o]}V(i,!0),setupInputValues(I,i)}}};I.find('input[name="variations.name"]').focus(function(){""===$(this).val()&&$(this).val(cutString(M,100)).select()}),I.find('input[name="variations.sku"]').click(function(){var t=$(this).val();0===t.indexOf(z)?$(this).selectRange(z.length,t.length):$(this).select()});var G=I.find("#t"+J+"-variation-image")}}();