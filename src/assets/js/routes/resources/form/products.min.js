!function(){"use strict";var V=window.tabId,p=window.Tabs[V],G=p.commit,K=function(){return p.data},B=window.i18n;p.continue=function(){var t=p.$form,I=randomObjectId(),T=0,b={material:{title:"Material"},pattern:{title:B({en_us:"Pattern",pt_br:"Estampa"})},size:{title:B({en_us:"Size",pt_br:"Tamanho"})},colors:{title:B({en_us:"Colors",pt_br:"Cores"})}},w={};$.getJSON("json/misc/variations_grids.json",function(t){for(var n in t)t.hasOwnProperty(n)&&(b[n]=B(t[n]))}).always(function(){window.callApi("grids.json?fields=title,grid_id,options","GET",function(t,n){if(!t)for(var i=0;i<n.result.length;i++){var e=n.result[i],a=normalizeString(e.title);for(var r in b)b.hasOwnProperty(r)&&r!==e.grid_id&&normalizeString(b[r].title)===a&&delete b[r];b[e.grid_id]=e}})});var a=function(t,n,i){t.typeahead({hint:!0,highlight:!0,minLength:1},{name:n,source:i})},r=$("#t"+V+"-grids-list"),o='<div class="row gap-2"><div class="col-6"><div class="flexbox align-items-center"><div class="i-drag"></div><div class="input-group"><div class="input-group-prepend"><button class="btn btn-light remove-grid" type="button"><i class="fa fa-trash"></i></button></div><input class="form-control" type="text" name="grid" placeholder="'+B({en_us:"Size",pt_br:"Tamanho"})+'"></div></div></div><div class="col-6 hidden option-block"><div class="input-group"><input class="form-control" type="text" name="option" placeholder="M"><div class="input-group-append"><button class="btn btn-light add-option" type="button"><i class="fa fa-plus"></i></button></div></div></div></div><ul class="hide-empty badges-list"></ul>';window.Sortable.create(r[0],{onUpdate:function(t){var n=Object.keys(w),i=n.splice(t.oldIndex,1)[0];i&&n.splice(t.newIndex,0,i);for(var e={},a=0;a<n.length;a++){var r=n[a];e[r]=w[r]}w=e,y()}});var k=0,n=function(t){var n=r.find('input[name="grid"]').filter(function(){return""===$(this).val()});if(n.length)n.focus();else{var d=$("<li />",{html:o});r.append(d);var u,f,p,i=d.find('input[name="grid"]'),v=d.find(".option-block"),h=v.find('input[name="option"]'),e=!0,m=[],g=function(){s(d,h,u,f)};i.change(function(){if(!p){p=!0;var t=$(this).val().trim();if(""!==t){var n,i;for(var e in f&&(n=f),f=normalizeString(t),b)if(b.hasOwnProperty(e)&&normalizeString(b[e].title)===f){f=e,i=!0;break}if(!i)switch(f){case"cor":case"color":f="colors"}if(n!==f){if((m=function(t){var n=[];if(b[t]){var i=b[t].options;if(void 0!==i)for(var e=0;e<i.length;e++)n.push(i[e].text)}return n}(f)).length&&h.attr("placeholder",m[0]),w.hasOwnProperty(f)){for(var a=2;w.hasOwnProperty(f+"."+a);)a++;f+="."+a}n?(w[f]=w[n],delete w[n]):w[f]=[],b.hasOwnProperty(f)||(b[f]={title:t}),$(this).data("grid-id",f)}if(0===f.indexOf("colors")){if(!u){var r=b.colors.options;u=$("<input />",{class:"mb-10 form-control",placeholder:B({en_us:"Transparent",pt_br:"Transparente"}),type:"text",name:"rgb",keydown:function(t){switch(t.which){case 9:case 13:setTimeout(function(){h.focus()},100)}}}),v.prepend(u);var o={theme:"bootstrap",position:"top left",swatches:[],change:function(t){if(r)for(var n=0;n<r.length;n++){var i=r[n],e=i.colors;if(e&&e[0]===t)return h.typeahead("val",i.text),void g()}}};if(r)for(var s=0;s<r.length;s++){var l=r[s].colors;l&&l.length&&o.swatches.push(l[0])}u.minicolors(o);var c=u.nextAll(".minicolors-panel");c.css("top",-(c.height()+8)+"px")}u.focus()}else u&&(u.minicolors("destroy").remove(),u=null),h.focus()}else h.typeahead("val",""),1<k&&x(d,f);setTimeout(function(){p=!1},100)}}).keyup(function(){""!==i.val()?e&&(v.fadeIn(),e=!1,1===k&&$("#t"+V+"-add-option-header").fadeIn()):e||(v.fadeOut(),e=!0,1===k&&$("#t"+V+"-add-option-header").fadeOut())}).keydown(function(t){switch(t.which){case 9:case 13:p||setTimeout(function(){i.trigger("change")},100)}}),h.keydown(function(t){switch(t.which){case 9:setTimeout(function(){i.focus()},100);break;case 13:g()}}),a(i,"grids",substringMatcher(function(){var t=[];for(var n in b)b.hasOwnProperty(n)&&t.push(b[n].title);return t}())),a(h,"options",substringMatcher(function(){return m})),d.find(".remove-grid").click(function(){x(d,f)}),d.find(".add-option").click(function(){g()}),1===++k&&$("#t"+V+"-grids-list-header").slideDown(),d.slideDown(400,function(){t||i.focus(),setTimeout(function(){window.Sortable.create(d.find(".badges-list")[0],{onUpdate:function(t){var n=w[f],i=n.splice(t.oldIndex,1)[0];i&&n.splice(t.newIndex,0,i),y()}})},200)})}},f=function(t,n){var i;if(b[t]){var e=b[t].options;if(e)for(var a=0;a<e.length;a++)if(n===normalizeString(e[a].text)){i=e[a];break}}return i},s=function(n,t,i,e){var a=t.val().trim();if(t.typeahead("val","").attr("placeholder",a).focus(),e){var r,o,s,l=function(){var t;return o&&(r=o.option_id,t=o.value),function(t,n,i,e,a,r){for(var o=w[i],s=0;s<o.length;s++)if(e===o[s].option_id)return!1;var l=o.length,c={option_id:e,text:r};n&&(a=n.minicolors("value")),a&&(c.value=a),o[l]=c;var d=$("<li />",{html:'<span class="i-drag white"></span>'+r+'<i class="fa fa-times"></i>'});return t.find(".badges-list").append(d),d.find(".fa-times").click(function(){d.remove(),void 0!==l&&(o.splice(l,1),y())}),!0}(n,i,e,r,t,a)};if(o=f(e,normalizeString(a)))s=l();else for(var c=a.split(/[,;/\\|.]+/g),d=0;d<c.length;d++)if(""!==(a=c[d].trim())){r=normalizeString(a),o=f(e,r);var u=l();u&&!s&&(s=u)}s&&y()}},j=$("#t"+V+"-variations-list"),l=function(t){return j.children(":not(.disabled)").index(t)},U=function(e,a){return function(){var t,n=K();if($(this).is(":checked")){e.removeClass("disabled"),t=l(e);var i=JSON.parse($(this).data("variation"));n.variations?n.variations.splice(t,0,i):n.variations=[i],a.removeAttr("disabled")}else t=l(e),$(this).data("variation",JSON.stringify(n.variations[t])),1<n.variations.length?n.variations.splice(t,1):delete n.variations,e.addClass("disabled"),a.attr("disabled",!0);G(n,!0)}},z=function(t){return function(){d(l(t))}},y=function(){var S,P={};for(S in w){var t=w[S];t&&t.length&&(P[S]=t)}j.slideUp(400,function(){$(this).html("");var t,n,i,e=K(),a=getCombinations(P),r=[];for(t=0;t<a.length;t++){var o=a[t],s="",l=new RegExp("^"+M+"(\\s\\/\\s.*)$"),c=M,d={};for(S in o)if(o.hasOwnProperty(S)){var u=o[S].text;c+=" / "+u,s+="<span>"+u+"</span>";var f={text:u},p=o[S].value;p&&(f.value=p),S=S.replace(/\..*/,""),d.hasOwnProperty(S)?d[S].push(f):d[S]=[f]}var v=$("<li />",{html:'<div class="flexbox align-items-center"><div><div class="custom-control custom-checkbox"><input type="checkbox" class="custom-control-input" checked ><label class="custom-control-label fw-400 colored"> </label></div></div><button class="btn btn-light" type="button"><i class="fa fa-cog"></i><span class="i18n"> <span data-lang="en_us">Edit variation</span><span data-lang="pt_br">Editar variação</span></span></button></div>'});v.find("label").html(s);var h=v.find("button");h.click(z(v)),v.find('input[type="checkbox"]').change(U(v,h)),j.append(v),v.slideDown();var m={};if(e.variations){var g=r.length,b={matches:0,index:null};for(n=0;n<e.variations.length;n++){var w=e.variations[n].specifications,k=0;for(var y in w)if(w.hasOwnProperty(y)&&d.hasOwnProperty(y)){var x=!1;if((i=w[y].length)===d[y].length){for(var _=0;_<i;_++)if(w[y][_].text!==d[y][_].text){x=!0;break}}else x=!0;if(x){k=0;break}k++}if(!(k<b.matches)){if(k===b.matches){if(n!==g)continue;b.sameIndex=!0}if(b.index=n,k===Object.keys(d).length&&k===Object.keys(w).length){b.sameSpecs=!0;break}}}null!==b.index&&(m=e.variations[b.index],b.sameSpecs||(delete m._id,delete m.specifications,b.sameIndex||delete m.sku))}m._id||(m._id=objectIdPad(I,""+T),T++,m.specifications=d),m.name&&!l.test(m.name)||(m.name=c),r.push(m)}for(""===A&&"function"==typeof C&&C(),i=r.length,t=0;t<i;t++)if(!r[t].sku){for(var O=null;!O;)for(O=A+"-"+randomInt(100,999)+"-"+(t+1),n=0;n<i.length;n++)if(O===r[n].sku){O=null;break}r[t].sku=O}$(this).slideDown(),e.variations=r,G(e,!0)})};$("#t"+V+"-add-grid").click(function(){n()});var x=function(t,n){t.slideUp(400,function(){$(this).remove()}),0===--k&&$("#t"+V+"-grids-list-header, #t"+V+"-add-option-header").slideUp(),delete w[n],y()},i=function(t){var n,i=K(),e=i[t]||"",a=i.variations;if(n="name"===t?M:A,a){for(var r=new RegExp("^"+n),o=0;o<a.length;o++){var s=a[o];"string"==typeof s[t]&&(s[t]=s[t].replace(r,e))}G(i,!0)}"name"===t?M=e:A=e},A=K().sku||"",e=t.find('input[name="sku"]');e.click(function(){$(this).select()}).change(function(){i("sku")});var m=function(){for(var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZ",i=0;i<3;i++)t+=n.charAt(Math.floor(Math.random()*n.length));t+=randomInt(1e3,9999),e.val(t).trigger("change"),c(t,function(){m()})};$("#t"+V+"-random-sku").click(m);var C,c=function(t,a){t&&window.callApi("products.json?sku="+encodeURIComponent(t),"GET",function(t,n){if(!t){var i=n.result,e=i.length;e&&(1<e||i[0]._id!==p.resourceId)&&("function"==typeof a?a():app.toast({en_us:"There is another product registered with this same SKU",pt_br:"Existe outro produto cadastrado com este mesmo SKU"}))}})};p.resourceId?""!==A&&c(A):(C=function(){""===A&&m(),t.off("change",'input[name="name"]',C),C=null},t.on("change",'input[name="name"]',C)),setTimeout(function(){t.find('select[name="brands"],select[name="categories"]').each(function(){var e=$(this).prev(".dropdown-menu");if(e.length){var a=$(this);e.find(".bs-searchbox input").keydown(function(){var i=$(this);setTimeout(function(){var t=e.find(".dropdown-menu > .no-results");if(t.length){var n=$("<button />",{class:"btn btn-outline btn-secondary btn-sm btn-block",type:"button",html:'<i class="fa fa-plus"></i> '+B({en_us:"Add",pt_br:"Adicionar"}),click:function(){!function(i,n){var e=function(t){return JSON.stringify({_id:t,name:n})},a=$("<option />",{text:n,selected:!0,value:e(objectIdPad(I,""+T))});T++,i.append(a).selectpicker("refresh").trigger("change");var t=i.attr("name");window.callApi(t+".json","POST",function(t,n){t||(a.val(e(n._id)),i.trigger("change"))},{name:n})}(a,i.val())}});t.html(n)}},300)})}})},400);var M=K().name||"",g=B({en_us:"New product",pt_br:"Novo produto"}),_=t.find('input[name="name"]');_.attr("placeholder",B({en_us:"Long Sleeve Polo Shirt",pt_br:"Camisa Polo Manga Longa"})).click(function(){$(this).val()===g&&$(this).val("").trigger("change")}).change(function(){i("name")}),t.find('input[name="variations.name"]').attr("placeholder",B({en_us:"Long Sleeve Polo Shirt / M / Red",pt_br:"Camisa Polo Manga Longa / M / Vermelho"})),p.formSetup();var O=0,S=t.children("#t"+V+"-product-fields"),P=t.children("#t"+V+"-variation-fields");$("#t"+V+"-back-to-product").click(function(){P.slideUp(400,function(){S.slideDown()})});var d=function(c){var d=K(),u=d.variations;if(u&&0<=c&&u.length>c){var f,p;d.name||_.val(g).trigger("change"),d.sku||m(),O=c;var t=[];for(p=0;p<u.length;p++)p!==c&&(f=u[p]).sku&&4<Object.keys(f).length&&t.push(f.sku);if(t.length){var n=[];for(p=0;p<t.length;p++)n.push($("<a />",{class:"dropdown-item",text:t[p],href:"javascript:;",click:function(t){return function(){R(t)}}(p)}));L.html(n),N.show()}else N.hide();var v=(f=u[c]).specifications,h=P;S.slideUp(400,function(){var t="";for(var n in v){var i=v[n];if(i){for(t+='<h4><small class="subtitle m-0">'+b[n].title+"</small>",p=0;p<i.length;p++)t+=" <small>·</small> "+i[p].text;t+="</h4>"}}h.find("#t"+V+"-variation-specs").html(t),c<u.length-1?E.removeAttr("disabled"):E.attr("disabled",!0),0<c?D.removeAttr("disabled"):D.attr("disabled",!0);var e=d.pictures;if(e&&e.length){var a=[];for(p=0;p<e.length;p++){var r,o=e[p];r=o.hasOwnProperty("normal")?o.normal.url:o.zoom.url;var s=o._id,l={html:'<img src="'+r+'">',click:function(t){return function(){f.picture_id=t,G(K(),!0),$(this).addClass("selected").siblings(".selected").removeClass("selected")}}(s)};f.picture_id===s&&(l.class="selected"),a.push($("<span />",l))}J.show().find(".images-list").html(a)}else J.hide();h.find("input,select").data("object-id",f._id).each(function(){$(this).val($(this).data("default")||"")}),setupInputValues(h,f,"variations."),h.slideDown()})}},u=function(t){P.slideUp(400,function(){d(O+t)})},E=P.find("#t"+V+"-next-variation"),D=P.find("#t"+V+"-prev-variation");E.click(function(){u(1)}),D.click(function(){u(-1)});var N=P.find("#t"+V+"-copy-variation"),L=N.children("div"),R=function(t){var n=K(),i=n.variations;if(i){var e=i[t],a=i[O];if(e&&a){for(var r in e)if(e.hasOwnProperty(r))switch(r){case"_id":case"sku":case"specifications":case"name":break;default:a[r]=e[r]}G(n,!0),setupInputValues(P,n)}}};P.find('input[name="variations.name"]').focus(function(){""===$(this).val()&&$(this).val(cutString(M,100)).select()}),P.find('input[name="variations.sku"]').click(function(){var t=$(this).val();0===t.indexOf(A)?$(this).selectRange(A.length,t.length):$(this).select()});var J=P.find("#t"+V+"-variation-image")}}();