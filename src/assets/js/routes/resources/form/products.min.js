!function(){"use strict";var C=window.tabId,E=window.Tabs[C],D=E.commit,L=function(){return E.data},R=window.i18n;E.continue=function(){var t=E.$form,O=randomObjectId(),I=0,p={material:{title:"Material"},pattern:{title:R({en_us:"Pattern",pt_br:"Modelo"})},size:{title:R({en_us:"Size",pt_br:"Tamanho"})},colors:{title:R({en_us:"Color",pt_br:"Cor"})}},v={};window.callApi("grids.json?fields=title,grid_id,options","GET",function(t,i){if(!t)for(var n=0;n<i.result.length;n++){var e=i.result[n],a=normalizeString(e.title);for(var o in p)p.hasOwnProperty(o)&&o!==e.grid_id&&normalizeString(p[o].title)===a&&delete p[o];p[e.grid_id]=e}});var d=function(t,i,n){t.typeahead({hint:!0,highlight:!0,minLength:1},{name:i,source:n})},f=$("#t"+C+"-grids-list"),u='<div class="row gap-2"><div class="col-6"><div class="flexbox align-items-center"><div class="i-drag"></div><div class="input-group"><div class="input-group-prepend"><button class="btn btn-light remove-grid" type="button"><i class="fa fa-trash"></i></button></div><input class="form-control" type="text" name="grid" placeholder="'+R({en_us:"Size",pt_br:"Tamanho"})+'"></div></div></div><div class="col-6 hidden option-block"><div class="input-group"><input class="form-control" type="text" name="option" placeholder="GG"><div class="input-group-append"><button class="btn btn-light add-option" type="button"><i class="fa fa-plus"></i></button></div></div></div></div><ul class="hide-empty badges-list"></ul>';window.Sortable.create(f[0],{onUpdate:function(t){var i=Object.keys(v),n=i.splice(t.oldIndex,1)[0];n&&i.splice(t.newIndex,0,n);for(var e={},a=0;a<i.length;a++){var o=i[a];e[o]=v[o]}v=e,g()}});var h=0,i=function(t){var i=f.find('input[name="grid"]').filter(function(){return""===$(this).val()});if(i.length)i.focus();else{var a=$("<li />",{html:u});f.append(a);var o,r,n=a.find('input[name="grid"]'),e=a.find(".option-block"),s=e.find('input[name="option"]'),l=!0,c=[];n.change(function(){if(!r){r=!0;var t=$(this).val().trim();if(""!==t){var i;for(var n in o&&(i=o),o=normalizeString(t),p)if(p.hasOwnProperty(n)&&normalizeString(p[n].title)===o){o=n;break}if(i!==o){if(c=function(t){var i=[];if(p[t]){var n=p[t].options;if(void 0!==n)for(var e=0;e<n.length;e++)i.push(n[e].text)}return i}(o),v.hasOwnProperty(o)){for(var e=2;v.hasOwnProperty(o+"_"+e);)e++;o+="_"+e}i?(v[o]=v[i],delete v[i]):v[o]=[],p.hasOwnProperty(o)||(p[o]={title:t}),$(this).data("grid-id",o)}s.focus()}else s.val(""),1<h&&b(a);setTimeout(function(){r=!1},100)}}).keyup(function(){""!==n.val()?l&&(e.fadeIn(),l=!1,1===h&&$("#t"+C+"-add-option-header").fadeIn()):l||(e.fadeOut(),l=!0,1===h&&$("#t"+C+"-add-option-header").fadeOut())}).keydown(function(t){switch(t.which){case 9:case 13:r||setTimeout(function(){n.trigger("change")},100)}}),s.click(function(){$(this).select()}).keydown(function(t){switch(t.which){case 9:setTimeout(function(){n.focus()},100);break;case 13:m(a,s,o)}}),d(n,"grids",substringMatcher(function(){var t=[];for(var i in p)p.hasOwnProperty(i)&&t.push(p[i].title);return t}())),d(s,"options",substringMatcher(function(){return c})),a.find(".remove-grid").click(function(){b(a)}),a.find(".add-option").click(function(){m(a,s,o)}),1===++h&&$("#t"+C+"-grids-list-header").slideDown(),a.slideDown(400,function(){t||n.focus(),setTimeout(function(){window.Sortable.create(a.find(".badges-list")[0],{onUpdate:function(t){var i=v[o],n=i.splice(t.oldIndex,1)[0];n&&i.splice(t.newIndex,0,n),g()}})},200)})}},m=function(t,i,n){var e=i.val().split(",");i.val("").focus();for(var a=0;a<e.length;a++){var o=e[a].trim();if(""!==o){var r,s;if(n){var l,c,d=normalizeString(o);if(p[n]&&p[n].options)for(l=0;l<p[n].options.length;l++){var f=p[n].options[l];if(d===normalizeString(f.text)){d=f.option_id;break}}for(s=v[n],l=0;l<s.length;l++)if(d===s[l].option_id){c=!0;break}if(c)continue;r=s.length,s[r]={option_id:d,text:o}}var u=$("<li />",{html:'<span class="i-drag white"></span>'+o+'<i class="fa fa-times"></i>'});t.find(".badges-list").append(u),u.find(".fa-times").click(function(){u.remove(),void 0!==r&&(s.splice(r,1),g())}),g()}}},P=$("#t"+C+"-variations-list"),a=function(t){return P.children(":not(.disabled)").index(t)},T=function(n,e){return function(){var t,i=L();$(this).is(":checked")?(n.removeClass("disabled"),t=a(n),i.variations.splice(t,0,JSON.parse($(this).data("variation"))),e.removeAttr("disabled")):(t=a(n),$(this).data("variation",JSON.stringify(i.variations[t])),i.variations.splice(t,1),n.addClass("disabled"),e.attr("disabled",!0)),D(i,!0)}},U=function(t){return function(){s(a(t))}},g=function(){var _,S={};for(_ in v){var t=v[_];t&&t.length&&(S[_]=t)}P.slideUp(400,function(){$(this).html("");var t,i,n,e=L(),a=getCombinations(S),o=[];for(t=0;t<a.length;t++){var r=a[t],s="",l=z(),c=A,d={};for(_ in r)if(r.hasOwnProperty(_)){var f=r[_].text;c+=" / "+f,s+="<span>"+f+"</span>",d[_]=[{text:f}]}var u=$("<li />",{html:'<div class="flexbox align-items-center"><div><div class="custom-control custom-checkbox"><input type="checkbox" class="custom-control-input" checked ><label class="custom-control-label fw-400 colored"> </label></div></div><button class="btn btn-light" type="button"><i class="fa fa-cog"></i><span class="i18n"> <span data-lang="en_us">Edit variation</span><span data-lang="pt_br">Editar variação</span></span></button></div>'});u.find("label").html(s);var p=u.find("button");p.click(U(u)),u.find('input[type="checkbox"]').change(T(u,p)),P.append(u),u.slideDown();var v={};if(e.variations){var h=o.length,m={matches:0,index:null};for(i=0;i<e.variations.length;i++){var g=e.variations[i].specifications,b=0;for(var k in g)if(g.hasOwnProperty(k)&&d.hasOwnProperty(k)){var w=!1;if((n=g[k].length)===d[k].length){for(var x=0;x<n;x++)if(g[k][x].text!==d[k][x].text){w=!0;break}}else w=!0;if(w){b=0;break}b++}if(!(b<m.matches)){if(b===m.matches){if(i!==h)continue;m.sameIndex=!0}if(m.index=i,b===Object.keys(d).length){m.sameSpecs=!0;break}}}null!==m.index&&(v=e.variations[m.index],m.sameSpecs||(delete v._id,delete v.specifications,m.sameIndex||delete v.sku))}v._id||(v._id=objectIdPad(O,""+I),I++,v.specifications=d),v.name&&!l.test(v.name)||(v.name=c),o.push(v)}if(j||"function"!=typeof M||M(),j)for(n=o.length,t=0;t<n;t++)if(!o[t].sku){for(var y=null;!y;)for(y=j+"-"+randomInt(100,999)+"-"+t,i=0;i<n.length;i++)if(y===o[i].sku){y=null;break}o[t].sku=y}$(this).slideDown(),e.variations=o,D(e,!0)})};$("#t"+C+"-add-grid").click(function(){i()});var b=function(t){t.slideUp(400,function(){$(this).remove()}),0===--h&&$("#t"+C+"-grids-list-header, #t"+C+"-add-option-header").slideUp()},j=L().sku,e=t.find('input[name="sku"]');e.click(function(){$(this).select()}).change(function(){var t=L(),i=t.sku,n=t.variations;if(i&&n&&j){for(var e=new RegExp("^"+j+"(-[0-9]{3}-[0-9]+)$"),a=0;a<n.length;a++){var o=n[a];"string"==typeof o.sku&&(o.sku=o.sku.replace(e,i+"$1"))}D(t,!0)}j=i});var o=function(){for(var t="",i="ABCDEFGHIJKLMNOPQRSTUVWXYZ",n=0;n<3;n++)t+=i.charAt(Math.floor(Math.random()*i.length));t+=randomInt(1e3,9999),e.val(t).trigger("change"),r(t,function(){o()})};$("#t"+C+"-random-sku").click(o);var M,r=function(t,a){t&&window.callApi("products.json?sku="+encodeURIComponent(t),"GET",function(t,i){if(!t){var n=i.result,e=n.length;e&&(1<e||n[0]._id!==E.resourceId)&&("function"==typeof a?a():app.toast({en_us:"There is another product registered with this same SKU",pt_br:"Existe outro produto cadastrado com este mesmo SKU"}))}})};E.resourceId?j&&r(j):(M=function(){j||o(),t.off("change",'input[name="name"]',M),M=null},t.on("change",'input[name="name"]',M)),setTimeout(function(){t.find('select[name="brands"],select[name="categories"]').each(function(){var e=$(this).prev(".dropdown-menu");if(e.length){var a=$(this);e.find(".bs-searchbox input").keydown(function(){var n=$(this);setTimeout(function(){var t=e.find(".dropdown-menu > .no-results");if(t.length){var i=$("<button />",{class:"btn btn-outline btn-secondary btn-sm btn-block",type:"button",html:'<i class="fa fa-plus"></i> '+R({en_us:"Add",pt_br:"Adicionar"}),click:function(){!function(n,i){var e=function(t){return JSON.stringify({_id:t,name:i})},a=$("<option />",{text:i,selected:!0,value:e(objectIdPad(O,""+I))});I++,n.append(a).selectpicker("refresh").trigger("change");var t=n.attr("name");window.callApi(t+".json","POST",function(t,i){t||(a.val(e(i._id)),n.trigger("change"))},{name:i})}(a,n.val())}});t.html(i)}},300)})}})},400);var A=L().name||"";t.find('input[name="name"]').attr("placeholder",R({en_us:"Long Sleeve Polo Shirt",pt_br:"Camisa Polo Manga Longa"})).change(function(){var t=L(),i=t.name,n=t.variations;if(i&&n){for(var e=z(),a=0;a<n.length;a++){var o=n[a];"string"==typeof o.name&&(o.name=o.name.replace(e,i+"$1"))}D(t,!0)}A=i});var z=function(){return new RegExp("^"+A+"(\\s\\/\\s.*)$")};t.find('input[name="variations.name"]').attr("placeholder",R({en_us:"Long Sleeve Polo Shirt / M / Red",pt_br:"Camisa Polo Manga Longa / M / Vermelho"})),E.formSetup();var c=0,n=t.children("#t"+C+"-product-fields"),k=t.children("#t"+C+"-variation-fields");$("#t"+C+"-back-to-product").click(function(){k.slideUp(400,function(){n.slideDown()})});var s=function(e){var a=L().variations;if(a&&0<=e&&a.length>e){var o,r;c=e;var t=[];for(r=0;r<a.length;r++)r!==e&&(o=a[r]).sku&&4<Object.keys(o).length&&t.push(o.sku);if(t.length){var i=[];for(r=0;r<t.length;r++)i.push($("<a />",{class:"dropdown-item",text:t[r],href:"javascript:;",click:function(t){return function(){S(t)}}(r)}));_.html(i),y.show()}else y.hide();var s=(o=a[e]).specifications,l=k;n.slideUp(400,function(){var t="";for(var i in s){var n=s[i];if(n){for(t+='<h4><small class="subtitle m-0">'+p[i].title+"</small>",r=0;r<n.length;r++)t+=" <small>·</small> "+n[r].text;t+="</h4>"}}l.find("#t"+C+"-variation-specs").html(t),e<a.length-1?w.removeAttr("disabled"):w.attr("disabled",!0),0<e?x.removeAttr("disabled"):x.attr("disabled",!0),l.find("input,select").data("object-id",o._id).each(function(){$(this).val($(this).data("default")||"")}),setupInputValues(l,o,"variations."),l.slideDown()})}},l=function(t){k.slideUp(400,function(){s(c+t)})},w=k.find("#t"+C+"-next-variation"),x=k.find("#t"+C+"-prev-variation");w.click(function(){l(1)}),x.click(function(){l(-1)});var y=k.find("#t"+C+"-copy-variation"),_=y.children("div"),S=function(t){var i=L(),n=i.variations;if(n){var e=n[t],a=n[c];if(e&&a){for(var o in e)if(e.hasOwnProperty(o))switch(o){case"_id":case"sku":case"specifications":case"name":break;default:a[o]=e[o]}D(i,!0),setupInputValues(k,i)}}};k.find('input[name="variations.name"]').focus(function(){if(""===$(this).val()){var t=A;t&&$(this).val(cutString(t,100)).select()}}),k.find('input[name="variations.sku"]').click(function(){var t=$(this).val();0===t.indexOf(j)?$(this).selectRange(j.length,t.length):$(this).select()})}}();