/*!
 * Copyright 2018 E-Com Club
 */
!function(){"use strict";var a=window.tabId,b=window.Tabs[a],c=$("#"+a+"-tab-normal"),d=c.children("form");window.renderContentIds(c);var e,f,g=window.i18n,h=function(a,b,c,e){d.addClass("ajax");var f=function(a,b){d.removeClass("ajax"),a||c(b)};window.callApi(a,b,f,e)},i=b.commit,j=function(){return b.data},k=b.slug,l=b.resourceId,m=!!d.find('[name="slug"]').length;if(l){f=k+"/"+l+".json";var n=function(){h(f,"DELETE",function(a){window.location="/#/resources/"+k})};if($("#"+a+"-delete").click(n),c.find(".delete-resource").click(n).fadeIn(),$("#"+a+"-duplicate").click(function(){h(k+".json","POST",function(a){window.location="/#/resources/"+k+"/"+a._id},j())}),$("#"+a+"-new").click(function(){window.location="/#/resources/"+k+"/new"}),m){var o=function(a){if(window.shopDomain&&j().slug){var b="https://"+window.shopDomain+"/"+j().slug;a&&(b=a+encodeURIComponent(b)),newTabLink(b)}else app.toast(g({en_us:"No link to share",pt_br:"Nenhum link para compartilhar"}))};$("#"+a+"-view").click(function(){o()}),$("#"+a+"-facebook").click(function(){o("https://www.facebook.com/sharer.php?u=")}),$("#"+a+"-whatsapp").click(function(){var a;a=$(window).width()<480?"api":"web",o("https://"+a+".whatsapp.com/send?text=")})}else $("#"+a+"-view, #"+a+"-facebook, #"+a+"-whatsapp").remove();$("#"+a+"-nav .edit-btn").fadeIn()}else e=!0,f=k+".json";var p=0,q=0,r=function(){if(++q>=p){var c,l=function(a,b){if(""===(b=b.trim()))return null;if(a.data("json")){var c;try{c=JSON.parse(b)}catch(a){c=!1}return c}return b},n=function(a,b){if(c){var d=a.attr("name");if(d&&""!==d){var e,f=j(),g=d.split(".");if(g.length){var h,k=a.data("object-id");for(e=0;;){if(""!==g[e]&&(e>0&&(f=f[d]),h?(d=parseInt(g[e],10),h=!1):(/\[\]$/.test(g[e])&&(h=!0,g[e]=g[e].slice(0,-2)),d=g[e])),e===g.length-1)break;if(f.hasOwnProperty(d)||(f[d]=k?[{_id:k}]:h?[]:{}),k){for(var m=0;m<f[d].length;m++)if(f[d][m]._id===k){g.splice(e+1,0,m),k=null;break}k&&(f[d].push({_id:k}),g.splice(e+1,0,f[d].length-1),k=null)}e++}}var n=function(){if(Array.isArray(f)?f.splice(d,1):delete f[d],g.length){f=j();for(var a=0;a<g.length-1;a++){var b=g[a];Object.keys(f[b]).length?f=f[b]:delete f[b]}}};if(b)f[d]=a.is(":checked");else{var o,p=a.data("value")||a.val();if("string"==typeof p)if((o=a.data("is-number")?stringToNumber(p):"number"===a.attr("type")?parseFloat(p):l(a,p))||0===o)if(a.data("object-assign"))f[d]=Object.assign(f[d],o);else{if(Array.isArray(f))for(;f.length<d;)f.push(o);f[d]=o}else{if(null!==o&&!isNaN(o)||!f.hasOwnProperty(d))return;n()}else if(Array.isArray(p)){var q=[];for(e=0;e<p.length;e++)(o=l(a,p[e]))&&q.push(o);if(q.length)f[d]=q;else{if(!f.hasOwnProperty(d))return;n()}}}i(j(),!0)}}};b.inputToData=n,handleInputs(d,n);var o=function(){e||setupInputValues(d,j()),d.find(".tagsinput").tagsinput(),d.find("select:not(.tagsinput)").selectpicker({style:"btn-light",noneSelectedText:"--",windowPadding:70});var b=d.find(".html-editor");if(b.length){var l=!1;b.summernote({toolbar:[["style",["style"]],["font",["bold","italic","underline","strikethrough","clear"]],["color",["color"]],["insert",["picture","link","video","hr","table"]],["paragraph",["ul","ol","paragraph"]],["misc",["codeview","help"]]],height:300,dialogsFade:!0,callbacks:{onChange:function(a){l=!0;var c=a.trim();"<div>"!==c.substring(0,5)&&b.summernote("code","<div><br></div>"+c)},onBlur:function(){l&&(b.trigger("change"),l=!1)}}})}var n=function(a){return function(b){b.stopPropagation();var c=$(this),d=j(),e=d[a];Array.isArray(e)&&(e=e[c.index()]);var f=function(b,f){if(!b){if(!1===f)Array.isArray(d[a])?d[a].splice(c.index(),1):delete d[a],c.toggle("slide",function(){$(this).remove()});else if("object"==typeof e)for(var g in f){var h=f[g];if(h)if(e.hasOwnProperty("zoom"))if("size"!==g)for(var j in e)e.hasOwnProperty(j)&&(e[j][g]=h);else e.zoom[g]=h;else e[g]=h}i(d,!0)}};window.editImage(f,e.zoom||e)}};d.find('input[type="file"]').each(function(){var a,c,f,h,k,l;c=$(this).attr("multiple"),c?(h=$(this).data("max"),h||(h=50),a=g({en_us:"Select images",pt_br:"Selecionar imagens"})):(h=1,a=g({en_us:"Select image",pt_br:"Selecionar imagem"})),k=$(this).attr("name"),f=$(this).data("thumbnails");var m=function(a,d,e){if(!a){var m=j();if(m.hasOwnProperty(k)){var p=function(a){if(a){if(!f){var b=a.url;a={zoom:a},-1!==b.indexOf("digitaloceanspaces.com/@")?a.normal={url:b.replace(/^((https?:)?\/\/[^\/]+\/)(.*)$/,"$1imgs/400px/$3")}:a.normal=a.zoom}d.push(a)}};if(c)for(l=0;l<m[k].length;l++){var r=m[k][l];p(r)}else d.length||p(m[k])}if(!d.length)return;if(d.length>h&&(c?(f&&d.splice(h,d.length-h),app.toast(g({en_us:"A maximum of "+h+" images will be selected",pt_br:"No máximo "+h+" imagens serão selecionadas"}))):app.toast(g({en_us:"Only one image will be selected",pt_br:"Apenas uma imagem será selecionada"}))),!o){q.addClass("ajax");var s=q.children(".images-list");s.html("");var t=0,u=0,v=[],w=function(){++u===t&&(s.prepend(v),q.removeClass("ajax"),u>1&&window.Sortable.create(s[0],{onUpdate:function(a){var b=j(),c=b[k].splice(a.oldIndex,1)[0];c&&(b[k].splice(a.newIndex,0,c),i(b,!0))}}))};if(!e){if(c){m[k]=[];var x=randomObjectId();for(l=0;l<d.length;l++){var y;y=f?d[l]:d[l].zoom,y._id||(y._id=objectIdPad(x,""+l)),m[k].push(y)}}else m[k]=f?d[0]:d[0].zoom;i(m,!0)}}for(l=0;l<d.length&&l<h;l++)!function(){var a;if(o?a=d[l].zoom.url:(t++,a=d[l].normal.url),o||v.push($("<span />",{html:'<img src="'+a+'"><i class="fa fa-cog"></i>',click:n(k)})),o)b.summernote("insertImage","../assets/img/util/loading.gif",function(c){var d=new Image;d.onload=function(){c.attr("src",a),b.summernote("insertText"," ")},d.src=a,c.css("max-width","100%")});else{var c=new Image;c.onload=function(){w(),clearTimeout(e)};var e=setTimeout(w,5e3);c.src=a}}()}},o=$(this).hasClass("note-image-input"),p=function(){var a;o?(d.find(".note-editor .modal.show").modal("hide"),a=400):a=100,window.setImagesCallback(m),setTimeout(function(){window.upload()},a)},q=$("<div/>",{class:"select-image scrollable ajax-content",html:'<div class="ajax-overlay"><div class="spinner-circle-material"></div></div><div class="images-list"></div><p><i class="fa fa-picture-o"></i>&nbsp; '+a+"</p>",click:p});$(this).replaceWith(q),e||m(null,[],!0)}),setTimeout(function(){window.setSaveAction(d,function(b){setTimeout(function(){var c,d=j();e?(c="POST",d.name&&!d.slug&&m&&(d.slug=clearAccents(d.name.toLowerCase(),"-").replace(/[^a-z0-9-_.\/]/g,""))):c="PUT",h(f,c,function(c){"function"==typeof b&&b(a),e&&c._id&&(window.location="/#/resources/"+k+"/"+c._id)},d)},200)})},200),c=!0,fixScrollbars(d),d.removeClass("ajax ajax-cards")};b.wait?(b.$form=d,b.formSetup=function(){setTimeout(o,100)},"function"==typeof b.continue&&b.continue()):setTimeout(o,200)}},s=d.find("select").filter(function(){return $(this).data("fill")});s.length?s.each(function(){var a=$(this).data("fill");p++;var b=[$(this)];d.find('select[data-fill-same="'+$(this).attr("name")+'"]').each(function(){b.push($(this))});var c,e,f=a+".json?sort="+($(this).data("sort")||"name"),g=$(this).data("properties");g&&(e=!0,f+="&fields="+g,(c=$(this).data("subtext-property"))&&(f+=","+c)),window.callApi(f,"GET",function(a,d){if(!a){var f=d.result;if(f)for(var h=0;h<f.length;h++){var i=f[h];if(i._id!==l){var j;if(e){var k;k=g?getProperties(i,g):i,j=JSON.stringify(k)}else j=i._id;var m={value:j,text:cutString(i.name,42,"...")};if(c){var n=getFromDotNotation(i,c);n&&(m["data-subtext"]=cutString(n,45,"..."))}for(var o=0;o<b.length;o++)$("<option />",m).appendTo(b[o])}}}r()})}):r()}();