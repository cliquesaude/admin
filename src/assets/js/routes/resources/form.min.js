/*!
 * Copyright 2018 E-Com Club
 */
!function(){"use strict";var a=window.tabId,b=$("#"+a+"-tab-normal"),c=b.children("form");window.renderContentIds(b);var d,e,f=window.i18n,g=function(a,b,d,e){c.addClass("ajax");var f=function(a,b){c.removeClass("ajax"),a||d(b)};window.callApi(a,b,f,e)},h=window.tabCommit[a],i=function(){return window.tabData[a]},j=window.routeParams[0],k=window.routeParams[1];if("new"===k)d=!0,e=j+".json";else{e=j+"/"+k+".json";var l=function(){g(e,"DELETE",function(a){window.location="/#/resources/"+j})};$("#"+a+"-delete").click(l),b.find(".delete-resource").click(l).fadeIn(),$("#"+a+"-duplicate").click(function(){g(j+".json","POST",function(a){window.location="/#/resources/"+j+"/"+a._id},i())});var m=function(a){if(window.shopDomain&&i().slug){var b="https://"+window.shopDomain+"/"+i().slug;a&&(b=a+encodeURIComponent(b)),window.newTabLink(b)}else app.toast(f({en_us:"No link to share",pt_br:"Nenhum link para compartilhar"}))};$("#"+a+"-view").click(function(){m()}),$("#"+a+"-facebook").click(function(){m("https://www.facebook.com/sharer.php?u=")}),$("#"+a+"-whatsapp").click(function(){var a;a=$(window).width()<480?"api":"web",m("https://"+a+".whatsapp.com/send?text=")}),$("#"+a+"-nav .edit-btn").fadeIn()}var n=0,o=0,p=function(){if(++o===n){var b=function(a,b){if(""===(b=b.trim()))return null;if(a.data("json")){var c;try{c=JSON.parse(b)}catch(a){c=!1}return c}return b};if(c.find('input[type="text"],select,textarea').change(function(){var a=$(this).attr("name");if(a&&""!==a){var c,d=i(),e=$(this).val();if("string"==typeof e)if(c=b($(this),e))d[a]=c;else{if(null!==c||!d.hasOwnProperty(a))return;delete d[a]}else if(Array.isArray(e)){for(var f=[],g=0;g<e.length;g++)(c=b($(this),e[g]))&&f.push(c);if(f.length)d[a]=f;else{if(!d.hasOwnProperty(a))return;delete d[a]}}h(d,!0)}}),!d){var k=i();for(var l in k){var m=k[l],p=$('[name="'+l+'"]');if(p&&!p.is("input:file"))switch(typeof m){case"string":p.val(m);break;case"object":if(Array.isArray(m)){for(var q=[],r=0;r<m.length;r++){var s=m[r];"string"!=typeof s?q.push(JSON.stringify(s)):q.push(s)}p.val(q)}else null!==m&&p.val(JSON.stringify(m))}}}c.find(".tagsinput").tagsinput(),c.find("select:not(.tagsinput)").selectpicker({style:"btn-light",noneSelectedText:"--"});var t=c.find(".html-editor"),u=!1;t.summernote({toolbar:[["style",["style"]],["font",["bold","italic","underline","strikethrough","clear"]],["color",["color"]],["insert",["picture","link","video","hr","table"]],["paragraph",["ul","ol","paragraph"]],["misc",["codeview","help"]]],height:400,dialogsFade:!0,callbacks:{onChange:function(a){u=!0;var b=a.trim();"<div>"!==b.substring(0,5)&&t.summernote("code","<div><br></div>"+b)},onBlur:function(){u&&(t.trigger("change"),u=!1)}}});var v=function(a){return function(b){b.stopPropagation();var c=$(this);window.editImage(function(b,d){if(!b){var e=c.index(),f=i();if(!1===d)Array.isArray(f[a])?f[a].splice(e,1):delete f[a],c.toggle("slide",function(){$(this).remove()});else{var g=f[a];if("object"==typeof g){Array.isArray(g)&&(g=g[e]);for(var j in d){var k=d[j];if(k)if(g.hasOwnProperty("zoom"))if("size"!==j)for(var l in g)g.hasOwnProperty(l)&&(g[l][j]=k);else g.zoom[j]=k;else g[j]=k}}}h(f,!0)}})}};c.find('input[type="file"]').each(function(){var a,b,e,g,j,k;b=$(this).attr("multiple"),b?(g=$(this).data("max"),g||(g=50),a=f({en_us:"Select images",pt_br:"Selecionar imagens"})):(g=1,a=f({en_us:"Select image",pt_br:"Selecionar imagem"})),j=$(this).attr("name"),e=$(this).data("thumbnails");var l=function(a,c,d){if(!a){var l=i();if(l.hasOwnProperty(j)){var n=function(a){if(a){if(!e){var b=a.url;a={zoom:a},-1!==b.indexOf("digitaloceanspaces.com/@")?a.normal={url:b.replace(/^((https?:)?\/\/[^\/]+\/)(.*)$/,"$1imgs/400px/$3")}:a.normal=a.zoom}c.push(a)}};if(b)for(k=0;k<l[j].length;k++){var p=l[j][k];n(p)}else c.length||n(l[j])}if(!c.length)return;if(c.length>g&&(b?(e&&c.splice(g,c.length-g),app.toast(f({en_us:"A maximum of "+g+" images will be selected",pt_br:"No máximo "+g+" imagens serão selecionadas"}))):app.toast(f({en_us:"Only one image will be selected",pt_br:"Apenas uma imagem será selecionada"}))),!m){o.addClass("ajax");var q=o.children(".images-list");q.html("");var r=0,s=0,u=[],w=function(){++s===r&&(q.prepend(u),o.removeClass("ajax"),s>1&&window.Sortable.create(q[0],{onUpdate:function(a){var b=i(),c=b[j].splice(a.oldIndex,1)[0];c&&(b[j].splice(a.newIndex,0,c),h(b,!0))}}))};if(!d){if(b){l[j]=[];var x="110000000000000000000000";for(k=0;k<c.length;k++){var y;y=e?c[k]:c[k].zoom;var z=""+k;y._id=x.substring(0,x.length-z.length)+z,l[j].push(y)}}else l[j]=e?c[0]:c[0].zoom;h(l,!0)}}for(k=0;k<c.length&&k<g;k++)!function(){var a;m?a=c[k].zoom.url:(r++,a=c[k].normal.url),m||u.push($("<span />",{html:'<img src="'+a+'" /><i class="fa fa-cog"></i>',click:v(j)}));var b=function(){m?t.summernote("insertImage",a,function(a){a.css("max-width","100%")}):w()},d=new Image;d.onload=function(){b(),clearTimeout(e)};var e=setTimeout(b,5e3);d.src=a}()}},m=$(this).hasClass("note-image-input"),n=function(){var a;m?(c.find(".note-editor .modal.show").modal("hide"),a=400):a=100,window.setImagesCallback(l),setTimeout(function(){window.upload()},a)},o=$("<div/>",{class:"select-image scrollable ajax-content",html:'<div class="ajax-overlay"><div class="spinner-circle-material"></div></div><div class="images-list"></div><p><i class="fa fa-picture-o"></i>&nbsp; '+a+"</p>",click:n});$(this).replaceWith(o),d||l(null,[],!0)}),window.setSaveAction(c,function(b){var c;c=d?"POST":"PUT",g(e,c,function(c){"function"==typeof b&&b(a),d&&c._id&&(window.location="/#/resources/"+j+"/"+c._id)},i())}),window.fixScrollbars(c),c.removeClass("ajax ajax-cards")}};c.find("select").each(function(a){var b=$(this).data("fill");if(b){n++;var d=[$(this)];c.find('select[data-fill-same="'+$(this).attr("name")+'"]').each(function(){d.push($(this))});var e,f=b+".json",g=$(this).data("properties");g&&(e=!0,f+="?fields="+g),window.callApi(f,"GET",function(a,b){if(!a){var c=b.result;if(c)for(var f=0;f<c.length;f++){var g=c[f];if(g._id!==k)for(var h=0;h<d.length;h++){var i;i=e?JSON.stringify(g):g._id,$("<option />",{value:i,text:g.name}).appendTo(d[h])}}}p()})}})}();