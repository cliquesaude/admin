/*!
 * Copyright 2018 E-Com Club
 */
!function(){"use strict";var a=window.tabId,b=$("#"+a+"-tab-normal"),c=b.children("form");window.renderContentIds(b);var d,e,f=window.i18n,g=function(a,b,d,e){c.addClass("ajax");var f=function(a,b){c.removeClass("ajax"),a||d(b)};window.callApi(a,b,f,e)},h=window.Tabs[a].commit,i=function(){return window.Tabs[a].data},j=window.routeParams[0],k=window.routeParams[1],l=!!c.find('[name="slug"]').length;if("new"===k)d=!0,e=j+".json";else{e=j+"/"+k+".json";var m=function(){g(e,"DELETE",function(a){window.location="/#/resources/"+j})};if($("#"+a+"-delete").click(m),b.find(".delete-resource").click(m).fadeIn(),$("#"+a+"-duplicate").click(function(){g(j+".json","POST",function(a){window.location="/#/resources/"+j+"/"+a._id},i())}),$("#"+a+"-new").click(function(){window.location="/#/resources/"+j+"/new"}),l){var n=function(a){if(window.shopDomain&&i().slug){var b="https://"+window.shopDomain+"/"+i().slug;a&&(b=a+encodeURIComponent(b)),newTabLink(b)}else app.toast(f({en_us:"No link to share",pt_br:"Nenhum link para compartilhar"}))};$("#"+a+"-view").click(function(){n()}),$("#"+a+"-facebook").click(function(){n("https://www.facebook.com/sharer.php?u=")}),$("#"+a+"-whatsapp").click(function(){var a;a=$(window).width()<480?"api":"web",n("https://"+a+".whatsapp.com/send?text=")})}else $("#"+a+"-view, #"+a+"-facebook, #"+a+"-whatsapp").remove();$("#"+a+"-nav .edit-btn").fadeIn()}var o=0,p=0,q=function(){if(++p>=o){var b=function(a,b){if(""===(b=b.trim()))return null;if(a.data("json")){var c;try{c=JSON.parse(b)}catch(a){c=!1}return c}return b},k=function(a,c){var d=a.attr("name");if(d&&""!==d){var e,f=i(),g=d.split(".");if(g.length){var j=a.data("object-id");for(e=0;;){if(d=g[e],e===g.length-1)break;if(f.hasOwnProperty(d)||(f[d]=j?[{_id:j}]:{}),j){for(var k=0;k<f[d].length;k++)if(f[d][k]._id===j){f=f[d][k],j=null;break}j&&(f[d].push({_id:j}),f=f[d][f[d].length-1],j=null)}else f=f[d];e++}}var l=function(){if(delete f[d],g.length){f=i();for(var a=0;a<g.length-1;a++){var b=g[a];Object.keys(f[b]).length?f=f[b]:delete f[b]}}};if(c)f[d]=a.is(":checked");else{var m,n=a.val();if("string"==typeof n)if(m=b(a,n))f[d]=m;else{if(null!==m||!f.hasOwnProperty(d))return;l()}else if(Array.isArray(n)){var o=[];for(e=0;e<n.length;e++)(m=b(a,n[e]))&&o.push(m);if(o.length)f[d]=o;else{if(!f.hasOwnProperty(d))return;l()}}}h(i(),!0)}};if(window.Tabs[a].inputToData=k,c.find('input[type="checkbox"]').change(function(){k($(this),!0)}),c.find('input[type="radio"]').change(function(){var a=c.find('input[name="'+$(this).attr("name")+'"]:checked');k(a);var b=a.data("disable");b&&c.find('[name="'+b+'"]').each(function(){$(this).data("enable-value")===a.val()?$(this).removeAttr("disabled"):$(this).attr("disabled",!0).val("").trigger("change")})}),c.find('input[type="text"],select,textarea').change(function(){k($(this));var a=$(this).data("fill-field");if(a){var b=c.find('[name="'+a+'"]'),d=$(this).val();"lower"===b.data("fill-case")&&(d=d.toLowerCase());var e=b.data("fill-clear-accents");e&&(d=clearAccents(d,e),console.log(d));var f=b.data("fill-pattern");f&&(d=d.replace(new RegExp(f,"g"),""));var g=b.attr("maxlength");g&&(d=d.substr(0,parseInt(g,10))),b.val(d).trigger("change")}}),!d){var m=i();for(var n in m){var q=m[n],r=$('[name="'+n+'"]');if(r&&!r.is("input:file"))switch(typeof q){case"string":r.val(q);break;case"object":if(Array.isArray(q)){for(var s=[],t=0;t<q.length;t++){var u=q[t];"string"!=typeof u?s.push(JSON.stringify(u)):s.push(u)}r.val(s)}else null!==q&&r.val(JSON.stringify(q))}}}c.find(".tagsinput").tagsinput(),c.find("select:not(.tagsinput)").selectpicker({style:"btn-light",noneSelectedText:"--",windowPadding:70});var v=c.find(".html-editor");if(v.length){var w=!1;v.summernote({toolbar:[["style",["style"]],["font",["bold","italic","underline","strikethrough","clear"]],["color",["color"]],["insert",["picture","link","video","hr","table"]],["paragraph",["ul","ol","paragraph"]],["misc",["codeview","help"]]],height:300,dialogsFade:!0,callbacks:{onChange:function(a){w=!0;var b=a.trim();"<div>"!==b.substring(0,5)&&v.summernote("code","<div><br></div>"+b)},onBlur:function(){w&&(v.trigger("change"),w=!1)}}})}var x=function(a){return function(b){b.stopPropagation();var c=$(this),d=i(),e=d[a];Array.isArray(e)&&(e=e[c.index()]);var f=function(b,f){if(!b){if(!1===f)Array.isArray(d[a])?d[a].splice(c.index(),1):delete d[a],c.toggle("slide",function(){$(this).remove()});else if("object"==typeof e)for(var g in f){var i=f[g];if(i)if(e.hasOwnProperty("zoom"))if("size"!==g)for(var j in e)e.hasOwnProperty(j)&&(e[j][g]=i);else e.zoom[g]=i;else e[g]=i}h(d,!0)}};window.editImage(f,e.zoom||e)}};c.find('input[type="file"]').each(function(){var a,b,e,g,j,k;b=$(this).attr("multiple"),b?(g=$(this).data("max"),g||(g=50),a=f({en_us:"Select images",pt_br:"Selecionar imagens"})):(g=1,a=f({en_us:"Select image",pt_br:"Selecionar imagem"})),j=$(this).attr("name"),e=$(this).data("thumbnails");var l=function(a,c,d){if(!a){var l=i();if(l.hasOwnProperty(j)){var n=function(a){if(a){if(!e){var b=a.url;a={zoom:a},-1!==b.indexOf("digitaloceanspaces.com/@")?a.normal={url:b.replace(/^((https?:)?\/\/[^\/]+\/)(.*)$/,"$1imgs/400px/$3")}:a.normal=a.zoom}c.push(a)}};if(b)for(k=0;k<l[j].length;k++){var p=l[j][k];n(p)}else c.length||n(l[j])}if(!c.length)return;if(c.length>g&&(b?(e&&c.splice(g,c.length-g),app.toast(f({en_us:"A maximum of "+g+" images will be selected",pt_br:"No máximo "+g+" imagens serão selecionadas"}))):app.toast(f({en_us:"Only one image will be selected",pt_br:"Apenas uma imagem será selecionada"}))),!m){o.addClass("ajax");var q=o.children(".images-list");q.html("");var r=0,s=0,t=[],u=function(){++s===r&&(q.prepend(t),o.removeClass("ajax"),s>1&&window.Sortable.create(q[0],{onUpdate:function(a){var b=i(),c=b[j].splice(a.oldIndex,1)[0];c&&(b[j].splice(a.newIndex,0,c),h(b,!0))}}))};if(!d){if(b){l[j]=[];var w=randomObjectId();for(k=0;k<c.length;k++){var y;y=e?c[k]:c[k].zoom,y._id||(y._id=objectIdPad(w,""+k)),l[j].push(y)}}else l[j]=e?c[0]:c[0].zoom;h(l,!0)}}for(k=0;k<c.length&&k<g;k++)!function(){var a;m?a=c[k].zoom.url:(r++,a=c[k].normal.url),m||t.push($("<span />",{html:'<img src="'+a+'"><i class="fa fa-cog"></i>',click:x(j)}));var b=function(){m?v.summernote("insertImage",a,function(a){a.css("max-width","100%")}):u()},d=new Image;d.onload=function(){b(),clearTimeout(e)};var e=setTimeout(b,5e3);d.src=a}()}},m=$(this).hasClass("note-image-input"),n=function(){var a;m?(c.find(".note-editor .modal.show").modal("hide"),a=400):a=100,window.setImagesCallback(l),setTimeout(function(){window.upload()},a)},o=$("<div/>",{class:"select-image scrollable ajax-content",html:'<div class="ajax-overlay"><div class="spinner-circle-material"></div></div><div class="images-list"></div><p><i class="fa fa-picture-o"></i>&nbsp; '+a+"</p>",click:n});$(this).replaceWith(o),d||l(null,[],!0)}),window.setSaveAction(c,function(b){var c,f=i();d?(c="POST",f.name&&!f.slug&&l&&(f.slug=clearAccents(f.name.toLowerCase(),"-").replace(/[^a-z0-9-_.\/]/g,""))):c="PUT",g(e,c,function(c){"function"==typeof b&&b(a),d&&c._id&&(window.location="/#/resources/"+j+"/"+c._id)},f)}),fixScrollbars(c),c.removeClass("ajax ajax-cards")}},r=c.find("select");r.length?r.each(function(a){var b=$(this).data("fill");if(b){o++;var d=[$(this)];c.find('select[data-fill-same="'+$(this).attr("name")+'"]').each(function(){d.push($(this))});var e,f,g=b+".json?sort="+($(this).data("sort")||"name"),h=$(this).data("properties");h&&(f=!0,g+="&fields="+h,(e=$(this).data("subtext-property"))&&(g+=","+e)),window.callApi(g,"GET",function(a,b){if(!a){var c=b.result;if(c)for(var g=0;g<c.length;g++){var i=c[g];if(i._id!==k){var j;if(f){var l;l=h?getProperties(i,h):i,j=JSON.stringify(l)}else j=i._id;var m={value:j,text:cutString(i.name,42,"...")};if(e){var n=getFromDotNotation(i,e);n&&(m["data-subtext"]=cutString(n,45,"..."))}for(var o=0;o<d.length;o++)$("<option />",m).appendTo(d[o])}}}q()})}}):q()}();