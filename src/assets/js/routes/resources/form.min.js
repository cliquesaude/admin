/*!
 * Copyright 2018 E-Com Club
 */
!function(){"use strict";var a=window.tabId,b=$("#"+a+"-tab-normal"),c=b.children("form");window.renderContentIds(b);var d,e,f=window.i18n,g=function(a,b,d,e){c.addClass("ajax");var f=function(a,b){c.removeClass("ajax"),a||d(b)};window.callApi(a,b,f,e)},h=window.Tabs[a].commit,i=function(){return window.Tabs[a].data},j=window.routeParams[0],k=window.routeParams[1],l=!!c.find('[name="slug"]').length;if("new"===k)d=!0,e=j+".json";else{e=j+"/"+k+".json";var m=function(){g(e,"DELETE",function(a){window.location="/#/resources/"+j})};if($("#"+a+"-delete").click(m),b.find(".delete-resource").click(m).fadeIn(),$("#"+a+"-duplicate").click(function(){g(j+".json","POST",function(a){window.location="/#/resources/"+j+"/"+a._id},i())}),$("#"+a+"-new").click(function(){window.location="/#/resources/"+j+"/new"}),l){var n=function(a){if(window.shopDomain&&i().slug){var b="https://"+window.shopDomain+"/"+i().slug;a&&(b=a+encodeURIComponent(b)),newTabLink(b)}else app.toast(f({en_us:"No link to share",pt_br:"Nenhum link para compartilhar"}))};$("#"+a+"-view").click(function(){n()}),$("#"+a+"-facebook").click(function(){n("https://www.facebook.com/sharer.php?u=")}),$("#"+a+"-whatsapp").click(function(){var a;a=$(window).width()<480?"api":"web",n("https://"+a+".whatsapp.com/send?text=")})}else $("#"+a+"-view, #"+a+"-facebook, #"+a+"-whatsapp").remove();$("#"+a+"-nav .edit-btn").fadeIn()}var o=0,p=0,q=function(){if(++p>=o){var b=function(a,b){if(""===(b=b.trim()))return null;if(a.data("json")){var c;try{c=JSON.parse(b)}catch(a){c=!1}return c}return b},k=function(a,c){var d=a.attr("name");if(d&&""!==d){var e,f=i(),g=d.split(".");if(g.length){var j,k=a.data("object-id");for(e=0;;){if(""!==g[e]&&(e>0&&(f=f[d]),j?(d=parseInt(g[e],10),j=!1):(/\[\]$/.test(g[e])&&(j=!0,g[e]=g[e].slice(0,-2)),d=g[e])),e===g.length-1)break;if(f.hasOwnProperty(d)||(f[d]=k?[{_id:k}]:j?[]:{}),k){for(var l=0;l<f[d].length;l++)if(f[d][l]._id===k){g.splice(e+1,0,l),k=null;break}k&&(f[d].push({_id:k}),g.splice(e+1,0,f[d].length-1),k=null)}e++}}var m=function(){if(Array.isArray(f)?f.splice(d,1):delete f[d],g.length){f=i();for(var a=0;a<g.length-1;a++){var b=g[a];Object.keys(f[b]).length?f=f[b]:delete f[b]}}};if(c)f[d]=a.is(":checked");else{var n,o=a.data("value")||a.val();if("string"==typeof o)if(n=b(a,o))if(a.data("object-assign"))f[d]=Object.assign(f[d],n);else{if(Array.isArray(f))for(;f.length<d;)f.push(n);f[d]=n}else{if(null!==n||!f.hasOwnProperty(d))return;m()}else if(Array.isArray(o)){var p=[];for(e=0;e<o.length;e++)(n=b(a,o[e]))&&p.push(n);if(p.length)f[d]=p;else{if(!f.hasOwnProperty(d))return;m()}}}h(i(),!0)}};if(window.Tabs[a].inputToData=k,handleInputs(c,k),!d){var m=function(a,b){b||(b="");for(var c in a){var d=a[c],e=$('[name="'+b+c+'"]');if(e.length){if(!e.is("input:file"))switch(typeof d){case"string":"radio"!==e.attr("type")?e.val(d):console.log(d);break;case"object":if(Array.isArray(d)){for(var f=[],g=0;g<d.length;g++){var h=d[g];"string"!=typeof h?f.push(JSON.stringify(h)):f.push(h)}e.val(f)}else null!==d&&e.val(JSON.stringify(d));break;case"boolean":d?e.attr("checked",!0):e.removeAttr("checked")}}else"object"==typeof d&&null!==d&&(Array.isArray(d)||m(d,b+c+"."))}};m(i())}c.find(".tagsinput").tagsinput(),c.find("select:not(.tagsinput)").selectpicker({style:"btn-light",noneSelectedText:"--",windowPadding:70});var n=c.find(".html-editor");if(n.length){var q=!1;n.summernote({toolbar:[["style",["style"]],["font",["bold","italic","underline","strikethrough","clear"]],["color",["color"]],["insert",["picture","link","video","hr","table"]],["paragraph",["ul","ol","paragraph"]],["misc",["codeview","help"]]],height:300,dialogsFade:!0,callbacks:{onChange:function(a){q=!0;var b=a.trim();"<div>"!==b.substring(0,5)&&n.summernote("code","<div><br></div>"+b)},onBlur:function(){q&&(n.trigger("change"),q=!1)}}})}var r=function(a){return function(b){b.stopPropagation();var c=$(this),d=i(),e=d[a];Array.isArray(e)&&(e=e[c.index()]);var f=function(b,f){if(!b){if(!1===f)Array.isArray(d[a])?d[a].splice(c.index(),1):delete d[a],c.toggle("slide",function(){$(this).remove()});else if("object"==typeof e)for(var g in f){var i=f[g];if(i)if(e.hasOwnProperty("zoom"))if("size"!==g)for(var j in e)e.hasOwnProperty(j)&&(e[j][g]=i);else e.zoom[g]=i;else e[g]=i}h(d,!0)}};window.editImage(f,e.zoom||e)}};c.find('input[type="file"]').each(function(){var a,b,e,g,j,k;b=$(this).attr("multiple"),b?(g=$(this).data("max"),g||(g=50),a=f({en_us:"Select images",pt_br:"Selecionar imagens"})):(g=1,a=f({en_us:"Select image",pt_br:"Selecionar imagem"})),j=$(this).attr("name"),e=$(this).data("thumbnails");var l=function(a,c,d){if(!a){var l=i();if(l.hasOwnProperty(j)){var o=function(a){if(a){if(!e){var b=a.url;a={zoom:a},-1!==b.indexOf("digitaloceanspaces.com/@")?a.normal={url:b.replace(/^((https?:)?\/\/[^\/]+\/)(.*)$/,"$1imgs/400px/$3")}:a.normal=a.zoom}c.push(a)}};if(b)for(k=0;k<l[j].length;k++){var q=l[j][k];o(q)}else c.length||o(l[j])}if(!c.length)return;if(c.length>g&&(b?(e&&c.splice(g,c.length-g),app.toast(f({en_us:"A maximum of "+g+" images will be selected",pt_br:"No máximo "+g+" imagens serão selecionadas"}))):app.toast(f({en_us:"Only one image will be selected",pt_br:"Apenas uma imagem será selecionada"}))),!m){p.addClass("ajax");var s=p.children(".images-list");s.html("");var t=0,u=0,v=[],w=function(){++u===t&&(s.prepend(v),p.removeClass("ajax"),u>1&&window.Sortable.create(s[0],{onUpdate:function(a){var b=i(),c=b[j].splice(a.oldIndex,1)[0];c&&(b[j].splice(a.newIndex,0,c),h(b,!0))}}))};if(!d){if(b){l[j]=[];var x=randomObjectId();for(k=0;k<c.length;k++){var y;y=e?c[k]:c[k].zoom,y._id||(y._id=objectIdPad(x,""+k)),l[j].push(y)}}else l[j]=e?c[0]:c[0].zoom;h(l,!0)}}for(k=0;k<c.length&&k<g;k++)!function(){var a;m?a=c[k].zoom.url:(t++,a=c[k].normal.url),m||v.push($("<span />",{html:'<img src="'+a+'"><i class="fa fa-cog"></i>',click:r(j)}));var b=function(){m?n.summernote("insertImage",a,function(a){a.css("max-width","100%")}):w()},d=new Image;d.onload=function(){b(),clearTimeout(e)};var e=setTimeout(b,5e3);d.src=a}()}},m=$(this).hasClass("note-image-input"),o=function(){var a;m?(c.find(".note-editor .modal.show").modal("hide"),a=400):a=100,window.setImagesCallback(l),setTimeout(function(){window.upload()},a)},p=$("<div/>",{class:"select-image scrollable ajax-content",html:'<div class="ajax-overlay"><div class="spinner-circle-material"></div></div><div class="images-list"></div><p><i class="fa fa-picture-o"></i>&nbsp; '+a+"</p>",click:o});$(this).replaceWith(p),d||l(null,[],!0)}),window.setSaveAction(c,function(b){var c,f=i();d?(c="POST",f.name&&!f.slug&&l&&(f.slug=clearAccents(f.name.toLowerCase(),"-").replace(/[^a-z0-9-_.\/]/g,""))):c="PUT";var h=function(c){"function"==typeof b&&b(a),d&&c._id&&(window.location="/#/resources/"+j+"/"+c._id)};setTimeout(function(){g(e,c,h,f)},200)}),fixScrollbars(c),c.removeClass("ajax ajax-cards")}},r=c.find("select");r.length?r.each(function(a){var b=$(this).data("fill");if(b){o++;var d=[$(this)];c.find('select[data-fill-same="'+$(this).attr("name")+'"]').each(function(){d.push($(this))});var e,f,g=b+".json?sort="+($(this).data("sort")||"name"),h=$(this).data("properties");h&&(f=!0,g+="&fields="+h,(e=$(this).data("subtext-property"))&&(g+=","+e)),window.callApi(g,"GET",function(a,b){if(!a){var c=b.result;if(c)for(var g=0;g<c.length;g++){var i=c[g];if(i._id!==k){var j;if(f){var l;l=h?getProperties(i,h):i,j=JSON.stringify(l)}else j=i._id;var m={value:j,text:cutString(i.name,42,"...")};if(e){var n=getFromDotNotation(i,e);n&&(m["data-subtext"]=cutString(n,45,"..."))}for(var o=0;o<d.length;o++)$("<option />",m).appendTo(d[o])}}}q()})}}):q()}();