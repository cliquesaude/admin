!function(){"use strict";var J=window.tabId,h=window.Tabs[J],V=h.commit,G=function(){return h.data},p=window.i18n;h.continue=function(){var t=h.$form,A=randomObjectId(),j=0,y={size:{title:p({en_us:"Size",pt_br:"Tamanho"})},material:{title:"Material"},pattern:{title:p({en_us:"Pattern",pt_br:"Estampa"})},colors:{title:p({en_us:"Primary color",pt_br:"Cor primária"})},"colors.2":{title:p({en_us:"Secondary color",pt_br:"Cor secundária"})}},_={};$.getJSON("json/misc/variations_grids.json",function(t){for(var i in t){var e=t[i];e&&(y.hasOwnProperty(i)&&e.options?y[i].options=p(e.options):y[i]=p(e))}}).always(function(){window.callApi("grids.json?fields=title,grid_id,options","GET",function(t,i){if(!t)for(var e=0;e<i.result.length;e++){var n=i.result[e],a=normalizeString(n.title);for(var r in y)y.hasOwnProperty(r)&&r!==n.grid_id&&normalizeString(y[r].title)===a&&delete y[r];y[n.grid_id]=n}setTimeout(function(){var s=G().variations;if(Array.isArray(s)&&s.length){var t=function(n,a){setTimeout(function(){for(var t=0;t<s.length;t++){var i=s[t].specifications[a];if(Array.isArray(i))for(var e=0;e<i.length;e++)n(i[e])}},600)},i=s[0].specifications;if(i)for(var e in i){var n;if(i.hasOwnProperty(e))n=y.hasOwnProperty(e)?y[e]:{title:e},t(o(n),e)}setTimeout(function(){O(!0),setTimeout(function(){for(var t=C.find('input[type="checkbox"]'),i=0;i<s.length;i++){var e="",n=s[i].specifications;for(var a in n){var r=n[a];if(Array.isArray(r))for(var o=0;o<r.length;o++)e+=","+r[o].value}t.filter(function(){return $(this).data("value")===e}).data("checked",!0)}t.filter(function(){return!$(this).data("checked")}).prop("checked",!1).trigger("change").removeData("checked")},200)},800)}},100)})});var n=function(t,i,e){t.typeahead({hint:!0,highlight:!0,minLength:1},{name:i,source:e})},a=$("#t"+J+"-grids-list"),r='<div class="row gap-2"><div class="col-6"><div class="flexbox align-items-center"><div class="i-drag"></div><div class="input-group"><div class="input-group-prepend"><button class="btn btn-light remove-grid" type="button"><i class="fa fa-trash"></i></button></div><input class="form-control" type="text" name="grid" placeholder="'+p({en_us:"Size",pt_br:"Tamanho"})+'"></div></div></div><div class="col-6 hidden option-block"><div class="input-group"><input class="form-control" type="text" name="option" placeholder="M"><div class="input-group-append"><button class="btn btn-light add-option" type="button"><i class="fa fa-plus"></i></button></div></div></div></div><ul class="hide-empty badges-list"></ul>';window.Sortable.create(a[0],{handle:".i-drag",onUpdate:function(t){var i=Object.keys(_),e=i.splice(t.oldIndex,1)[0];e&&i.splice(t.newIndex,0,e);for(var n={},a=0;a<i.length;a++){var r=i[a];n[r]=_[r]}_=n,O()}});var x=0,o=function(t){var i=a.find('input[name="grid"]').filter(function(){return""===$(this).val()});if(!i.length){var f=$("<li />",{html:r});a.append(f);var u,v,h,p=f.find('input[name="grid"]'),g=f.find(".option-block"),m=g.find('input[name="option"]'),e=!0,b=!0,w=[];t&&p.val(t.title);var k=function(t){var i;i=t?Object.assign({},t):null,s(f,m,u,v,i)};return p.change(function(){if(!h){h=!0;var t=$(this).val().trim();if(""!==t){var i,e;for(var n in v&&(i=v),v=normalizeString(t),y)if(y.hasOwnProperty(n)&&normalizeString(y[n].title)===v){v=n,e=!0;break}if(!e)switch(v){case"cores":case"cor":case"color":v="colors";break;case"tamanhos":case"tamanho":case"sizes":v="size"}if(i!==v){if((w=function(t){var i=[];if(y[t]){var e=y[t].options;if(void 0!==e)for(var n=0;n<e.length;n++)i.push(e[n].text)}return i}(v)).length&&m.attr("placeholder",w[0]),_.hasOwnProperty(v)){for(var a=2;_.hasOwnProperty(v+"."+a);)a++;v+="."+a}i?(_[v]=_[i],delete _[i]):_[v]=[],y.hasOwnProperty(v)||(y[v]={title:t}),$(this).data("grid-id",v)}if(0===v.indexOf("colors")){if(!u){var r,o=y.colors.options;u=$("<input />",{class:"form-control",placeholder:"#ffffff",type:"text",name:"rgb",keydown:function(t){switch(t.which){case 9:setTimeout(function(){p.focus()},100);break;case 13:$(this).trigger("change")}},change:function(){var t=$(this).val().trim().toLowerCase();if(/^#[a-f0-9]{6}$/.test(t)){if(o)for(var i=0;i<o.length;i++){var e=o[i],n=e.colors;if(n&&n[0]===t)return m.typeahead("val",e.text),r.slideUp(),void k()}var a=function(){m.focus()};r.is(":visible")?setTimeout(a,100):r.slideDown(400,a)}}}),g.prepend(u),(r=u.nextAll()).addClass("mt-10").hide();var s={theme:"bootstrap",position:"top left",swatches:[]};if(o)for(var l=0;l<o.length;l++){var c=o[l].colors;c&&c.length&&s.swatches.push(c[0])}u.minicolors(s);var d=u.nextAll(".minicolors-panel");d.addClass("swatches-only").css("top",-(d.height()+8)+"px")}b&&u.focus()}else u&&(u.minicolors("destroy").remove(),u=null),b&&m.focus()}else m.typeahead("val",""),1<x&&S(f,v);b=!0,setTimeout(function(){h=!1},100)}}).blur(function(){h||setTimeout(function(){p.trigger("change")},100)}).keyup(function(){""!==p.val()?e&&(g.fadeIn(),e=!1,1===x&&$("#t"+J+"-add-option-header").fadeIn()):e||(g.fadeOut(),e=!0,1===x&&$("#t"+J+"-add-option-header").fadeOut())}).keydown(function(t){switch(t.which){case 9:case 13:p.trigger("blur")}}),m.keydown(function(t){switch(t.which){case 9:setTimeout(function(){p.focus()},100);break;case 13:k()}}),n(p,"grids",substringMatcher(function(){var t=[];for(var i in y)y.hasOwnProperty(i)&&t.push(y[i].title);return t}())),n(m,"options",substringMatcher(function(){return w})),f.find(".remove-grid").click(function(){S(f,v)}),f.find(".add-option").click(function(){k()}),1===++x&&$("#t"+J+"-grids-list-header").slideDown(),f.slideDown(400,function(){t?(b=!1,p.trigger("keyup").trigger("change")):p.focus(),setTimeout(function(){window.Sortable.create(f.find(".badges-list")[0],{onUpdate:function(t){var i=_[v],e=i.splice(t.oldIndex,1)[0];e&&i.splice(t.newIndex,0,e),O()}})},200)}),k}i.focus()},v=function(t,i){var e;if(y[t]){var n=y[t].options;if(n)for(var a=0;a<n.length;a++)if(i===normalizeString(n[a].text)){e=n[a];break}}return e},s=function(i,t,e,n,a){var r,o,s,l,c=function(){var t;return a&&(o=a.option_id,t=a.value||a.option_id),function(t,i,e,n,a,r){for(var o=_[e],s=0;s<o.length;s++)if(n===o[s].option_id)return!1;var l={option_id:n,text:r};i&&(a=i.minicolors("value")),a&&(l.value=a),o.push(l);var c=$("<li />",{html:'<span class="i-drag white"></span>'+r+'<i class="fa fa-times"></i>'});return t.find(".badges-list").append(c),c.find(".fa-times").click(function(){if(c.remove(),n){if(1<o.length){for(var t=0;t<o.length;t++)if(o[t].option_id===n){o.splice(t,1);break}}else _[e]=[];O()}}),!0}(i,e,n,o,t,r)};if(a)l=!0,r=a.text,a.option_id||(a.option_id=a.value);else{if(r=t.val().trim(),t.typeahead("val","").attr("placeholder",r).focus(),!n)return;a=v(n,normalizeString(r))}if(a)s=c();else for(var d=r.split(/[,;/\\|.]+/g),f=0;f<d.length;f++)if(""!==(r=d[f].trim())){o=normalizeString(r),a=v(n,o);var u=c();u&&!s&&(s=u)}s&&!l&&O()},C=$("#t"+J+"-variations-list"),l=function(t){return C.children(":not(.disabled)").index(t)},z=function(n,a){return function(){var t,i=G();if($(this).is(":checked")){n.removeClass("disabled"),t=l(n);var e=JSON.parse($(this).data("variation"));i.variations?i.variations.splice(t,0,e):i.variations=[e],a.removeAttr("disabled")}else t=l(n),$(this).data("variation",JSON.stringify(i.variations[t])),1<i.variations.length?i.variations.splice(t,1):delete i.variations,n.addClass("disabled"),a.attr("disabled",!0);V(i,!0)}},U=function(t){return function(){f(l(t))}},O=function(P){var T,I={};for(T in _){var t=_[T];t&&t.length&&(I[T]=t)}C.slideUp(400,function(){var t,i,e,n;$(this).html(""),t=P?{}:G();var a=getCombinations(I);if(0<a.length){var r=[];for(i=0;i<a.length;i++){var o=a[i],s="",l=new RegExp("^"+E+"(\\s\\/\\s.*)$"),c=E,d="",f={};for(T in o)if(o.hasOwnProperty(T)){var u=o[T].text;c+=" / "+u,s+="<span>"+u+"</span>";var v={text:u},h=o[T].value||o[T].option_id;d+=","+h,h&&(v.value=h),T=T.replace(/\..*/,""),f.hasOwnProperty(T)?f[T].push(v):f[T]=[v]}var p=$("<li />",{html:'<div class="flexbox align-items-center"><div><div class="custom-control custom-checkbox"><input type="checkbox" class="custom-control-input" checked ><label class="custom-control-label fw-400 colored"> </label></div></div><button class="btn btn-light" type="button"><i class="fa fa-cog"></i><span class="i18n"> <span data-lang="en_us">Edit variation</span><span data-lang="pt_br">Editar variação</span></span></button></div>'});p.find("label").html(s);var g=p.find("button");if(g.click(U(p)),p.find('input[type="checkbox"]').data("value",d).change(z(p,g)),C.append(p),p.slideDown(),!P){var m={};if(t.variations){var b=r.length,w={matches:0,index:null};for(e=0;e<t.variations.length;e++){var k=t.variations[e].specifications,y=0;for(var _ in k)if(k.hasOwnProperty(_)&&f.hasOwnProperty(_)){var x=!1;if((n=k[_].length)===f[_].length){for(var O=0;O<n;O++)if(k[_][O].text!==f[_][O].text){x=!0;break}}else x=!0;if(x){y=0;break}y++}if(!(y<w.matches)){if(y===w.matches){if(e!==b)continue;w.sameIndex=!0}if(w.index=e,y===Object.keys(f).length&&y===Object.keys(k).length){w.sameSpecs=!0;break}}}null!==w.index&&(m=t.variations[w.index],w.sameSpecs||(delete m._id,delete m.specifications,w.sameIndex||delete m.sku))}m._id||(m._id=objectIdPad(A,""+j),j++,m.specifications=f),m.name&&!l.test(m.name)||(m.name=c),r.push(m)}}if(!P){for(""===M&&"function"==typeof D&&D(),n=r.length,i=0;i<n;i++)if(!r[i].sku){for(var S=null;!S;)for(S=M+"-"+randomInt(100,999)+"-"+(i+1),e=0;e<n.length;e++)if(S===r[e].sku){S=null;break}r[i].sku=S}t.variations=r}}else delete t.variations;$(this).slideDown(),P||V(t,!0)})};$("#t"+J+"-add-grid").click(function(){o()});var S=function(t,i){t.slideUp(400,function(){$(this).remove()}),0===--x&&$("#t"+J+"-grids-list-header, #t"+J+"-add-option-header").slideUp(),delete _[i],O()},i=function(t){var i,e=G(),n=e[t]||"",a=e.variations;if(i="name"===t?E:M,a){for(var r=new RegExp("^"+i),o=0;o<a.length;o++){var s=a[o];"string"==typeof s[t]&&(s[t]=s[t].replace(r,n))}V(e,!0)}"name"===t?E=n:M=n},M=G().sku||"",c=t.find('input[name="sku"]');c.click(function(){$(this).select()}).change(function(){i("sku")});var g=function(){for(var t="",i="ABCDEFGHIJKLMNOPQRSTUVWXYZ",e=0;e<3;e++)t+=i.charAt(Math.floor(Math.random()*i.length));t+=randomInt(1e3,9999),c.val(t).trigger("change"),d(t,function(){g()})};$("#t"+J+"-random-sku").click(g);var D,d=function(t,a){t&&window.callApi("products.json?sku="+encodeURIComponent(t),"GET",function(t,i){if(!t){var e=i.result,n=e.length;n&&(1<n||e[0]._id!==h.resourceId)&&("function"==typeof a?a():app.toast(p({en_us:"There is another product registered with this same SKU",pt_br:"Existe outro produto cadastrado com este mesmo SKU"})))}})};h.resourceId?""!==M&&d(M):(D=function(){""===M&&g(),t.off("change",'input[name="name"]',D),D=null},t.on("change",'input[name="name"]',D)),setTimeout(function(){t.find('select[name="brands"],select[name="categories"]').each(function(){var a=$(this).siblings(".dropdown-menu");if(a.length){var r,o=$(this);a.find(".bs-searchbox input").keydown(function(){var n=$(this);r&&clearTimeout(r),r=setTimeout(function(){r=null;var t=a.find(".dropdown-menu > .no-results");if(t.length){var i=$("<button />",{class:"btn btn-outline btn-secondary btn-sm btn-block",type:"button",html:'<i class="fa fa-plus"></i> '+p({en_us:"Add",pt_br:"Adicionar"}),click:function(){!function(e,i){var n=function(t){return JSON.stringify({_id:t,name:i})},a=$("<option />",{text:i,selected:!0,value:n(objectIdPad(A,""+j))});j++,e.append(a).selectpicker("refresh").trigger("change");var t=e.attr("name");window.callApi(t+".json","POST",function(t,i){t||(a.val(n(i._id)),e.trigger("change"))},{name:i})}(o,n.val())}}),e=$("<div />",{html:i});t.html(e),e.slideDown(120)}},300)})}})},400);var E=G().name||"",e=p({en_us:"New product",pt_br:"Novo produto"}),m=t.find('input[name="name"]');m.attr("placeholder",p({en_us:"Long Sleeve Polo Shirt",pt_br:"Camisa Polo Manga Longa"})).click(function(){$(this).val()===e&&$(this).val("").trigger("change")}).change(function(){i("name")}),t.find('input[name="variations.name"]').attr("placeholder",p({en_us:"Long Sleeve Polo Shirt / M / Red",pt_br:"Camisa Polo Manga Longa / M / Vermelho"})),h.formSetup();var b=0,w=t.children("#t"+J+"-product-fields"),k=t.children("#t"+J+"-variation-fields");$("#t"+J+"-back-to-product").click(function(){k.slideUp(400,function(){w.slideDown()})});var f=function(c){var d=G(),f=d.variations;if(f&&0<=c&&f.length>c){var u,v;d.name||m.val(e).trigger("change"),d.sku||g(),b=c;var t=[];for(v=0;v<f.length;v++)v!==c&&(u=f[v]).sku&&4<Object.keys(u).length&&t.push(u.sku);if(t.length){var i=[];for(v=0;v<t.length;v++)i.push($("<a />",{class:"dropdown-item",text:t[v],href:"javascript:;",click:function(t){return function(){N(t)}}(v)}));L.html(i),I.show()}else I.hide();var h=(u=f[c]).specifications,p=k;w.slideUp(400,function(){var t="";for(var i in h){var e=h[i];if(e){for(t+='<h4><small class="subtitle m-0">'+y[i].title+"</small>",v=0;v<e.length;v++)t+=" <small>·</small> "+e[v].text;t+="</h4>"}}p.find("#t"+J+"-variation-specs").html(t),c<f.length-1?P.removeAttr("disabled"):P.attr("disabled",!0),0<c?T.removeAttr("disabled"):T.attr("disabled",!0);var n=d.pictures;if(n&&n.length){var a=[];for(v=0;v<n.length;v++){var r,o=n[v];r=o.hasOwnProperty("normal")?o.normal.url:o.zoom.url;var s=o._id,l={html:'<img src="'+r+'">',click:function(t){return function(){u.picture_id=t,V(G(),!0),$(this).addClass("selected").siblings(".selected").removeClass("selected")}}(s)};u.picture_id===s&&(l.class="selected"),a.push($("<span />",l))}R.show().find(".images-list").html(a)}else R.hide();p.find("input,select").data("object-id",u._id).each(function(){$(this).val($(this).data("default")||"")}),setupInputValues(p,u,"variations."),p.slideDown()})}},u=function(t){k.slideUp(400,function(){f(b+t)})},P=k.find("#t"+J+"-next-variation"),T=k.find("#t"+J+"-prev-variation");P.click(function(){u(1)}),T.click(function(){u(-1)});var I=k.find("#t"+J+"-copy-variation"),L=I.children("div"),N=function(t){var i=G(),e=i.variations;if(e){var n=e[t],a=e[b];if(n&&a){for(var r in n)if(n.hasOwnProperty(r))switch(r){case"_id":case"sku":case"specifications":case"name":break;default:a[r]=n[r]}V(i,!0),setupInputValues(k,i)}}};k.find('input[name="variations.name"]').focus(function(){""===$(this).val()&&$(this).val(cutString(E,100)).select()}),k.find('input[name="variations.sku"]').click(function(){var t=$(this).val();0===t.indexOf(M)?$(this).selectRange(M.length,t.length):$(this).select()});var R=k.find("#t"+J+"-variation-image")}}();