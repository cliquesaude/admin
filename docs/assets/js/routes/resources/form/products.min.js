!function(){"use strict";var V=window.tabId,p=window.Tabs[V],G=p.commit,K=function(){return p.data},v=window.i18n;p.continue=function(){var t=p.$form,I=randomObjectId(),T=0,k={size:{title:v({en_us:"Size",pt_br:"Tamanho"})},material:{title:"Material"},pattern:{title:v({en_us:"Pattern",pt_br:"Estampa"})},colors:{title:v({en_us:"Primary color",pt_br:"Cor primária"})},"colors.2":{title:v({en_us:"Secondary color",pt_br:"Cor secundária"})}},y={};$.getJSON("json/misc/variations_grids.json",function(t){for(var i in t){var e=t[i];e&&(k.hasOwnProperty(i)&&e.options?k[i].options=v(e.options):k[i]=v(e))}}).always(function(){window.callApi("grids.json?fields=title,grid_id,options","GET",function(t,i){if(!t)for(var e=0;e<i.result.length;e++){var n=i.result[e],a=normalizeString(n.title);for(var o in k)k.hasOwnProperty(o)&&o!==n.grid_id&&normalizeString(k[o].title)===a&&delete k[o];k[n.grid_id]=n}})});var n=function(t,i,e){t.typeahead({hint:!0,highlight:!0,minLength:1},{name:i,source:e})},a=$("#t"+V+"-grids-list"),o='<div class="row gap-2"><div class="col-6"><div class="flexbox align-items-center"><div class="i-drag"></div><div class="input-group"><div class="input-group-prepend"><button class="btn btn-light remove-grid" type="button"><i class="fa fa-trash"></i></button></div><input class="form-control" type="text" name="grid" placeholder="'+v({en_us:"Size",pt_br:"Tamanho"})+'"></div></div></div><div class="col-6 hidden option-block"><div class="input-group"><input class="form-control" type="text" name="option" placeholder="M"><div class="input-group-append"><button class="btn btn-light add-option" type="button"><i class="fa fa-plus"></i></button></div></div></div></div><ul class="hide-empty badges-list"></ul>';window.Sortable.create(a[0],{handle:".i-drag",onUpdate:function(t){var i=Object.keys(y),e=i.splice(t.oldIndex,1)[0];e&&i.splice(t.newIndex,0,e);for(var n={},a=0;a<i.length;a++){var o=i[a];n[o]=y[o]}y=n,_()}});var x=0,i=function(t){var i=a.find('input[name="grid"]').filter(function(){return""===$(this).val()});if(i.length)i.focus();else{var f=$("<li />",{html:o});a.append(f);var u,p,v,h=f.find('input[name="grid"]'),g=f.find(".option-block"),m=g.find('input[name="option"]'),e=!0,b=[],w=function(){r(f,m,u,p)};h.change(function(){if(!v){v=!0;var t=$(this).val().trim();if(""!==t){var i,e;for(var n in p&&(i=p),p=normalizeString(t),k)if(k.hasOwnProperty(n)&&normalizeString(k[n].title)===p){p=n,e=!0;break}if(!e)switch(p){case"cores":case"cor":case"color":p="colors";break;case"tamanhos":case"tamanho":case"sizes":p="size"}if(i!==p){if((b=function(t){var i=[];if(k[t]){var e=k[t].options;if(void 0!==e)for(var n=0;n<e.length;n++)i.push(e[n].text)}return i}(p)).length&&m.attr("placeholder",b[0]),y.hasOwnProperty(p)){for(var a=2;y.hasOwnProperty(p+"."+a);)a++;p+="."+a}i?(y[p]=y[i],delete y[i]):y[p]=[],k.hasOwnProperty(p)||(k[p]={title:t}),$(this).data("grid-id",p)}if(0===p.indexOf("colors")){if(!u){var o,r=k.colors.options;u=$("<input />",{class:"form-control",placeholder:"#ffffff",type:"text",name:"rgb",keydown:function(t){switch(t.which){case 9:setTimeout(function(){h.focus()},100);break;case 13:$(this).trigger("change")}},change:function(){var t=$(this).val().trim().toLowerCase();if(/^#[a-f0-9]{6}$/.test(t)){if(r)for(var i=0;i<r.length;i++){var e=r[i],n=e.colors;if(n&&n[0]===t)return m.typeahead("val",e.text),o.slideUp(),void w()}var a=function(){m.focus()};o.is(":visible")?setTimeout(a,100):o.slideDown(400,a)}}}),g.prepend(u),(o=u.nextAll()).addClass("mt-10").hide();var s={theme:"bootstrap",position:"top left",swatches:[]};if(r)for(var l=0;l<r.length;l++){var c=r[l].colors;c&&c.length&&s.swatches.push(c[0])}u.minicolors(s);var d=u.nextAll(".minicolors-panel");d.addClass("swatches-only").css("top",-(d.height()+8)+"px")}u.focus()}else u&&(u.minicolors("destroy").remove(),u=null),m.focus()}else m.typeahead("val",""),1<x&&O(f,p);setTimeout(function(){v=!1},100)}}).keyup(function(){""!==h.val()?e&&(g.fadeIn(),e=!1,1===x&&$("#t"+V+"-add-option-header").fadeIn()):e||(g.fadeOut(),e=!0,1===x&&$("#t"+V+"-add-option-header").fadeOut())}).keydown(function(t){switch(t.which){case 9:case 13:v||setTimeout(function(){h.trigger("change")},100)}}),m.keydown(function(t){switch(t.which){case 9:setTimeout(function(){h.focus()},100);break;case 13:w()}}),n(h,"grids",substringMatcher(function(){var t=[];for(var i in k)k.hasOwnProperty(i)&&t.push(k[i].title);return t}())),n(m,"options",substringMatcher(function(){return b})),f.find(".remove-grid").click(function(){O(f,p)}),f.find(".add-option").click(function(){console.log("add option"),w()}),1===++x&&$("#t"+V+"-grids-list-header").slideDown(),f.slideDown(400,function(){t||h.focus(),setTimeout(function(){window.Sortable.create(f.find(".badges-list")[0],{onUpdate:function(t){var i=y[p],e=i.splice(t.oldIndex,1)[0];e&&i.splice(t.newIndex,0,e),_()}})},200)})}},u=function(t,i){var e;if(k[t]){var n=k[t].options;if(n)for(var a=0;a<n.length;a++)if(i===normalizeString(n[a].text)){e=n[a];break}}return e},r=function(i,t,e,n){console.log(i,t,e,n);var a=t.val().trim();if(t.typeahead("val","").attr("placeholder",a).focus(),n){var o,r,s,l=function(){var t;return r&&(o=r.option_id,t=r.value),function(t,i,e,n,a,o){for(var r=y[e],s=0;s<r.length;s++)if(n===r[s].option_id)return!1;var l={option_id:n,text:o};i&&(a=i.minicolors("value")),a&&(l.value=a),r.push(l);var c=$("<li />",{html:'<span class="i-drag white"></span>'+o+'<i class="fa fa-times"></i>'});return t.find(".badges-list").append(c),c.find(".fa-times").click(function(){if(c.remove(),n){if(1<r.length){for(var t=0;t<r.length;t++)if(r[t].option_id===n){r.splice(t,1);break}}else y[e]=[];_()}}),!0}(i,e,n,o,t,a)};if(r=u(n,normalizeString(a)))s=l();else for(var c=a.split(/[,;/\\|.]+/g),d=0;d<c.length;d++)if(""!==(a=c[d].trim())){o=normalizeString(a),r=u(n,o);var f=l();f&&!s&&(s=f)}s&&(console.log("generate variations"),_())}},j=$("#t"+V+"-variations-list"),s=function(t){return j.children(":not(.disabled)").index(t)},C=function(n,a){return function(){var t,i=K();if($(this).is(":checked")){n.removeClass("disabled"),t=s(n);var e=JSON.parse($(this).data("variation"));i.variations?i.variations.splice(t,0,e):i.variations=[e],a.removeAttr("disabled")}else t=s(n),$(this).data("variation",JSON.stringify(i.variations[t])),1<i.variations.length?i.variations.splice(t,1):delete i.variations,n.addClass("disabled"),a.attr("disabled",!0);G(i,!0)}},z=function(t){return function(){d(s(t))}},_=function(){var S,P={};for(S in y){var t=y[S];t&&t.length&&(P[S]=t)}j.slideUp(400,function(){$(this).html("");var t,i,e,n=K(),a=getCombinations(P);if(0<a.length){var o=[];for(t=0;t<a.length;t++){var r=a[t],s="",l=new RegExp("^"+M+"(\\s\\/\\s.*)$"),c=M,d={};for(S in r)if(r.hasOwnProperty(S)){var f=r[S].text;c+=" / "+f,s+="<span>"+f+"</span>";var u={text:f},p=r[S].value;p&&(u.value=p),S=S.replace(/\..*/,""),d.hasOwnProperty(S)?d[S].push(u):d[S]=[u]}var v=$("<li />",{html:'<div class="flexbox align-items-center"><div><div class="custom-control custom-checkbox"><input type="checkbox" class="custom-control-input" checked ><label class="custom-control-label fw-400 colored"> </label></div></div><button class="btn btn-light" type="button"><i class="fa fa-cog"></i><span class="i18n"> <span data-lang="en_us">Edit variation</span><span data-lang="pt_br">Editar variação</span></span></button></div>'});v.find("label").html(s);var h=v.find("button");h.click(z(v)),v.find('input[type="checkbox"]').change(C(v,h)),j.append(v),v.slideDown();var g={};if(n.variations){var m=o.length,b={matches:0,index:null};for(i=0;i<n.variations.length;i++){var w=n.variations[i].specifications,k=0;for(var y in w)if(w.hasOwnProperty(y)&&d.hasOwnProperty(y)){var x=!1;if((e=w[y].length)===d[y].length){for(var _=0;_<e;_++)if(w[y][_].text!==d[y][_].text){x=!0;break}}else x=!0;if(x){k=0;break}k++}if(!(k<b.matches)){if(k===b.matches){if(i!==m)continue;b.sameIndex=!0}if(b.index=i,k===Object.keys(d).length&&k===Object.keys(w).length){b.sameSpecs=!0;break}}}null!==b.index&&(g=n.variations[b.index],b.sameSpecs||(delete g._id,delete g.specifications,b.sameIndex||delete g.sku))}g._id||(g._id=objectIdPad(I,""+T),T++,g.specifications=d),g.name&&!l.test(g.name)||(g.name=c),o.push(g)}for(""===U&&"function"==typeof A&&A(),e=o.length,t=0;t<e;t++)if(!o[t].sku){for(var O=null;!O;)for(O=U+"-"+randomInt(100,999)+"-"+(t+1),i=0;i<e.length;i++)if(O===o[i].sku){O=null;break}o[t].sku=O}n.variations=o}else delete n.variations;$(this).slideDown(),G(n,!0)})};$("#t"+V+"-add-grid").click(function(){i()});var O=function(t,i){t.slideUp(400,function(){$(this).remove()}),0===--x&&$("#t"+V+"-grids-list-header, #t"+V+"-add-option-header").slideUp(),delete y[i],_()},e=function(t){var i,e=K(),n=e[t]||"",a=e.variations;if(i="name"===t?M:U,a){for(var o=new RegExp("^"+i),r=0;r<a.length;r++){var s=a[r];"string"==typeof s[t]&&(s[t]=s[t].replace(o,n))}G(e,!0)}"name"===t?M=n:U=n},U=K().sku||"",l=t.find('input[name="sku"]');l.click(function(){$(this).select()}).change(function(){e("sku")});var g=function(){for(var t="",i="ABCDEFGHIJKLMNOPQRSTUVWXYZ",e=0;e<3;e++)t+=i.charAt(Math.floor(Math.random()*i.length));t+=randomInt(1e3,9999),l.val(t).trigger("change"),c(t,function(){g()})};$("#t"+V+"-random-sku").click(g);var A,c=function(t,a){t&&window.callApi("products.json?sku="+encodeURIComponent(t),"GET",function(t,i){if(!t){var e=i.result,n=e.length;n&&(1<n||e[0]._id!==p.resourceId)&&("function"==typeof a?a():app.toast({en_us:"There is another product registered with this same SKU",pt_br:"Existe outro produto cadastrado com este mesmo SKU"}))}})};p.resourceId?""!==U&&c(U):(A=function(){""===U&&g(),t.off("change",'input[name="name"]',A),A=null},t.on("change",'input[name="name"]',A)),setTimeout(function(){t.find('select[name="brands"],select[name="categories"]').each(function(){var a=$(this).siblings(".dropdown-menu");if(a.length){var o,r=$(this);a.find(".bs-searchbox input").keydown(function(){var n=$(this);o&&clearTimeout(o),o=setTimeout(function(){o=null;var t=a.find(".dropdown-menu > .no-results");if(t.length){var i=$("<button />",{class:"btn btn-outline btn-secondary btn-sm btn-block",type:"button",html:'<i class="fa fa-plus"></i> '+v({en_us:"Add",pt_br:"Adicionar"}),click:function(){!function(e,i){var n=function(t){return JSON.stringify({_id:t,name:i})},a=$("<option />",{text:i,selected:!0,value:n(objectIdPad(I,""+T))});T++,e.append(a).selectpicker("refresh").trigger("change");var t=e.attr("name");window.callApi(t+".json","POST",function(t,i){t||(a.val(n(i._id)),e.trigger("change"))},{name:i})}(r,n.val())}}),e=$("<div />",{html:i});t.html(e),e.slideDown(120)}},300)})}})},400);var M=K().name||"",m=v({en_us:"New product",pt_br:"Novo produto"}),b=t.find('input[name="name"]');b.attr("placeholder",v({en_us:"Long Sleeve Polo Shirt",pt_br:"Camisa Polo Manga Longa"})).click(function(){$(this).val()===m&&$(this).val("").trigger("change")}).change(function(){e("name")}),t.find('input[name="variations.name"]').attr("placeholder",v({en_us:"Long Sleeve Polo Shirt / M / Red",pt_br:"Camisa Polo Manga Longa / M / Vermelho"})),p.formSetup();var w=0,S=t.children("#t"+V+"-product-fields"),P=t.children("#t"+V+"-variation-fields");$("#t"+V+"-back-to-product").click(function(){P.slideUp(400,function(){S.slideDown()})});var d=function(c){var d=K(),f=d.variations;if(f&&0<=c&&f.length>c){var u,p;d.name||b.val(m).trigger("change"),d.sku||g(),w=c;var t=[];for(p=0;p<f.length;p++)p!==c&&(u=f[p]).sku&&4<Object.keys(u).length&&t.push(u.sku);if(t.length){var i=[];for(p=0;p<t.length;p++)i.push($("<a />",{class:"dropdown-item",text:t[p],href:"javascript:;",click:function(t){return function(){R(t)}}(p)}));N.html(i),L.show()}else L.hide();var v=(u=f[c]).specifications,h=P;S.slideUp(400,function(){var t="";for(var i in v){var e=v[i];if(e){for(t+='<h4><small class="subtitle m-0">'+k[i].title+"</small>",p=0;p<e.length;p++)t+=" <small>·</small> "+e[p].text;t+="</h4>"}}h.find("#t"+V+"-variation-specs").html(t),c<f.length-1?D.removeAttr("disabled"):D.attr("disabled",!0),0<c?E.removeAttr("disabled"):E.attr("disabled",!0);var n=d.pictures;if(n&&n.length){var a=[];for(p=0;p<n.length;p++){var o,r=n[p];o=r.hasOwnProperty("normal")?r.normal.url:r.zoom.url;var s=r._id,l={html:'<img src="'+o+'">',click:function(t){return function(){u.picture_id=t,G(K(),!0),$(this).addClass("selected").siblings(".selected").removeClass("selected")}}(s)};u.picture_id===s&&(l.class="selected"),a.push($("<span />",l))}J.show().find(".images-list").html(a)}else J.hide();h.find("input,select").data("object-id",u._id).each(function(){$(this).val($(this).data("default")||"")}),setupInputValues(h,u,"variations."),h.slideDown()})}},f=function(t){P.slideUp(400,function(){d(w+t)})},D=P.find("#t"+V+"-next-variation"),E=P.find("#t"+V+"-prev-variation");D.click(function(){f(1)}),E.click(function(){f(-1)});var L=P.find("#t"+V+"-copy-variation"),N=L.children("div"),R=function(t){var i=K(),e=i.variations;if(e){var n=e[t],a=e[w];if(n&&a){for(var o in n)if(n.hasOwnProperty(o))switch(o){case"_id":case"sku":case"specifications":case"name":break;default:a[o]=n[o]}G(i,!0),setupInputValues(P,i)}}};P.find('input[name="variations.name"]').focus(function(){""===$(this).val()&&$(this).val(cutString(M,100)).select()}),P.find('input[name="variations.sku"]').click(function(){var t=$(this).val();0===t.indexOf(U)?$(this).selectRange(U.length,t.length):$(this).select()});var J=P.find("#t"+V+"-variation-image")}}();