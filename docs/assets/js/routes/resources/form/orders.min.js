!function(){"use strict";var u=window.i18n,f=window.tabId,e=window.Tabs[f],p=e.commit,h=function(){return e.data},n=function(){var n=h(),c=$("#t"+f+"-order-base"),e=c.find("#t"+f+"-order-amount"),a=e.find('input[name="amount.total"]');e.find('input:not([name="amount.total"])').change(function(){setTimeout(function(){var e=h().amount,n=(e.subtotal||0)+(e.freight||0)-(e.discount||0);e.tax&&(n+=e.tax),e.extra&&(n+=e.extra),a.val(formatMoney(0<=n?n:0)).trigger("change")},150)});var t,d,i=e.find("#t"+f+"-extra-amount"),o=function(){i.children("div").slideToggle()};i.children("a").click(o),n.amount&&(n.amount.tax||n.amount.extra)&&o(),setTimeout(function(){if(t=c.find("#t"+f+"-order-buyers"),d=t.find("#t"+f+"-buyer-info"),n.buyers)for(var e=0;e<n.buyers.length;e++)s(n.buyers[e])},200);var s=function(e){var n,t=e._id,a="",i=e.main_email;if(i&&(a+='<a href="mailto:'+i+'" target="_blank">'+i+"</a>"),e.name?(n=e.name.given_name,e.name.middle_name&&(n+=" "+e.name.middle_name),e.name.family_name&&(n+=" "+e.name.family_name),e.display_name&&(n+=" ("+e.display_name+")")):e.display_name&&(n=e.display_name),n&&(a+="<br>"+n),e.phones){e.phones.length&&(a+="<br>");for(var o=0;o<e.phones.length;o++)0<o&&(a+=" / "),a+='<span class="text-muted">'+e.phones[o].number+"</span>"}var s=$("<a>",{href:"#/resources/customers/"+t,html:'<i class="fa fa-pencil"></i> '+u({en_us:"edit registration",pt_br:"editar cadastro"})}),r=$("<i>",{class:"p-10 remove fa fa-trash"}).click(function(){for(var e=h(),n=e.buyers,a=0;a<n.length;a++){if(n[a]._id===t){n.splice(a,1),p(e,!0);break}}l.slideUp(300,function(){$(this).remove()})}),l=$("<div>",{class:"hidden mb-3 nested-block",html:[r,"<div>"+a+"</div>",s]});d.append(l),l.slideDown()},r=c.find("#t"+f+"-new-buyer"),l=r.find("input"),m=function(){r.addClass("ajax");var e="customers.json?main_email="+encodeURIComponent(l.val().trim());e+="&fields=_id,main_email,name,display_name,phones",window.callApi(e,"GET",function(e,n){if(r.removeClass("ajax"),!e){var a=n.result[0];if(a){for(var t=h(),i=t.buyers,o=0;o<i.length;o++)if(i[o]._id===a._id)return void app.toast(u({en_us:"This customer has already been added",pt_br:"Este cliente jÃ¡ foi adicionado"}));i.push(a),p(t,!0),s(a)}else app.toast(u({en_us:"No customers found with this email",pt_br:"Nenhum cliente encontrado com este e-mail"}))}})};l.click(function(){$(this).select()}).keydown(function(e){switch(e.which){case 13:e.preventDefault(),m()}}),r.find("button").click(m),c.find("#t"+f+"-add-buyer").click(function(){l.val(""),r.slideToggle()}),$.getJSON("json/misc/config_lists.json",function(e){for(var n=["status","financial_status/current","fulfillment_status/current"],a=0;a<n.length;a++){var t=n[a],i=t.replace("/","."),o=[],s=e.orders[t].enum;for(var r in s)s.hasOwnProperty(r)&&o.push($("<option>",{value:r,text:r,"data-content":'<span class="text-'+s[r].class+'">'+u(s[r].text)+"</span>"}));var l=c.find('select[name="'+i+'"]');l.html(o);var d=getFromDotNotation(h(),i);d&&l.val(d),l.selectpicker("refresh")}})};e.$form?n():$(document).one("form-"+f,n)}();